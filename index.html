<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Monopoly Classic</title>
<script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
<style>
* { box-sizing: border-box; }
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  text-align: center;
  margin: 0;
  padding: 20px;
  min-height: 100vh;
}
h2 { color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); margin-bottom: 10px; }
#status { color: white; font-size: 18px; font-weight: bold; margin-bottom: 15px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }

#menu-screen { max-width: 600px; margin: 50px auto; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
#menu-screen h3 { color: #2c3e50; margin-bottom: 30px; font-size: 24px; }

.menu-button {
  display: block; width: 100%; padding: 20px; margin: 15px 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold;
  cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.menu-button:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
.menu-button:active { transform: translateY(0); }
.menu-button.ai { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.menu-button.online { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.menu-button.local { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
.menu-button .subtitle { font-size: 14px; opacity: 0.9; margin-top: 5px; font-weight: normal; }

#player-count-screen { display: none; max-width: 500px; margin: 50px auto; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
#player-count-screen h3 { color: #2c3e50; margin-bottom: 30px; }
.player-count-btn {
  display: inline-block; width: 80px; padding: 20px; margin: 10px;
  background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
  color: white; border: none; border-radius: 12px; font-size: 24px; font-weight: bold;
  cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.player-count-btn:hover { transform: translateY(-3px); }

#online-lobby { display: none; max-width: 500px; margin: 50px auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
#online-lobby h3 { color: #2c3e50; margin-bottom: 20px; }
.lobby-section { margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; }
.lobby-input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; text-align: center; text-transform: uppercase; letter-spacing: 2px; }
.room-code-display { font-size: 32px; font-weight: bold; color: #667eea; letter-spacing: 4px; padding: 15px; background: white; border-radius: 8px; margin: 15px 0; }

.connection-status { padding: 10px; border-radius: 6px; margin: 10px 0; font-weight: bold; }
.status-waiting { background: #fff3cd; color: #856404; }
.status-connected { background: #d4edda; color: #155724; }
.status-error { background: #f8d7da; color: #721c24; }

#game-screen { display: none; }
#wrap { display: flex; justify-content: center; align-items: flex-start; margin-bottom: 20px; }

@media (max-width: 1300px) {
  #board { width: 98vw !important; height: calc(98vw * 0.73) !important; max-width: 1243px; max-height: 907px;
    grid-template-columns: repeat(11, calc((98vw - 26px) / 11)) !important;
    grid-template-rows: repeat(11, calc(((98vw - 26px) / 11) * 0.67)) !important;
  }
  .controls { width: 90% !important; max-width: 1243px; }
  .controls button { font-size: 10px !important; padding: 5px 8px !important; }
}

#board {
  display: grid;
  grid-template-columns: repeat(11, 110px);
  grid-template-rows: repeat(11, 73px);
  gap: 3px;
  background: #2c3e50; padding: 10px;
  border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.3);
  width: 1243px;
  height: 836px;
}

.tile {
  border: 2px solid #34495e; background: white; font-size: 8px;
  position: relative; padding: 2px; border-radius: 5px;
  transition: transform 0.2s, box-shadow 0.2s; overflow: hidden;
  display: flex; flex-direction: column;
}
.tile:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
.tile-header {
  font-weight: bold; text-align: center; padding: 1px 1px; border-radius: 3px;
  font-size: 10px; line-height: 1.1; margin-bottom: 1px; flex-shrink: 0;
}
.tile-num {
  font-size: 13px; font-weight: 900; text-align: center; line-height: 1;
}
.tile-price {
  font-size: 7px; font-weight: bold; text-align: center; color: #333; margin-bottom: 1px;
}
.rent-table {
  width: 100%; border-collapse: collapse; font-size: 6px; line-height: 1.1;
}
.rent-table td {
  padding: 0px 2px; white-space: nowrap;
}
.rent-table td.rlabel { color: #777; width: 30%; }
.rent-table td.rval  { font-weight: bold; color: #222; width: 20%; text-align: right; padding-right: 4px; }
.rent-table td.active-rent { color: #d32f2f !important; background: rgba(211,47,47,0.10); font-weight: bold; }
.tile-bottom {
  margin-top: auto; display: flex; justify-content: space-between; align-items: flex-end;
  padding-top: 2px;
}
.owner-dot {
  width: 12px; height: 12px; border-radius: 50%; border: 1.5px solid #333;
  display: flex; align-items: center; justify-content: center;
  font-size: 6px; font-weight: bold; color: white; flex-shrink: 0;
  box-shadow: 0 1px 3px rgba(0,0,0,0.4);
}
.pawns-area {
  display: flex; flex-wrap: wrap; gap: 1px; justify-content: flex-end;
}
.pawn {
  display: inline-block; width: 14px; height: 14px; border-radius: 50%;
  border: 2px solid #333; box-shadow: 0 1px 3px rgba(0,0,0,0.4);
  animation: pawnAppear 0.3s ease; flex-shrink: 0;
}
@keyframes pawnAppear { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.house {
  width: 10px; height: 10px; background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);
  display: inline-block; margin: 1px; border-radius: 2px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.3); animation: buildingAppear 0.3s ease;
}
.villa {
  width: 14px; height: 10px; background: linear-gradient(135deg, #e53935 0%, #ef5350 100%);
  display: inline-block; margin: 1px; border-radius: 2px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.4); animation: buildingAppear 0.3s ease;
}
@keyframes buildingAppear { from { transform: scale(0) rotate(0deg); } to { transform: scale(1) rotate(360deg); } }

.controls {
  background: rgba(255,255,255,0.95); padding: 12px 10px; border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15); width: 100%; flex-shrink: 0;
  display: flex; flex-direction: column; gap: 6px;
}
.control-row {
  display: flex; gap: 6px; justify-content: space-between;
}
.control-row button {
  padding: 10px 12px; margin: 0; font-size: 11px; font-weight: bold;
  border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2); flex: 1;
}
.control-row button:not(:disabled):hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
.control-row button:not(:disabled):active { transform: translateY(0); }
.control-row button:disabled { opacity: 0.4; cursor: not-allowed; }

.row-0 { background: #8d6e63; color: white; }
.row-1 { background: #81d4fa; color: #333; }
.row-2 { background: #f48fb1; color: white; }
.row-3 { background: #ffb74d; color: #333; }
.row-4 { background: #ef5350; color: white; }
.row-5 { background: #ba68c8; color: white; }
.row-6 { background: #ffa726; color: white; }
.row-7 { background: #42a5f5; color: white; }

.luck-tile { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%) !important; }
.jail-tile { background: linear-gradient(135deg, #607d8b 0%, #90a4ae 100%) !important; }
.rail-tile { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%) !important; color: white !important; }
.rail-tile .tile-header { background: #e94560 !important; color: white !important; }
.utility-tile { background: linear-gradient(135deg, #26c6da 0%, #00acc1 100%) !important; color: white !important; }
.utility-tile .tile-header { background: #00838f !important; color: white !important; }
.go-tile { background: linear-gradient(135deg, #e8f5e9 0%, #a5d6a7 100%) !important; }
.gotojail-tile { background: linear-gradient(135deg, #ffebee 0%, #ef9a9a 100%) !important; }
.freeparking-tile { background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%) !important; }
.tax-tile { background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%) !important; }

.tile.sellable { cursor: pointer; box-shadow: 0 0 10px rgba(76,175,80,0.8) !important; border: 3px solid #4CAF50 !important; }
.tile.sellable:hover { transform: translateY(-4px) !important; }
.tile.buildable { cursor: pointer; box-shadow: 0 0 10px rgba(255,152,0,0.8) !important; border: 3px solid #FF9800 !important; }
.tile.mortgageable { cursor: pointer; box-shadow: 0 0 10px rgba(255,193,7,0.8) !important; border: 3px solid #FFC107 !important; }
.tile.unmortgageable { cursor: pointer; box-shadow: 0 0 10px rgba(63,81,181,0.8) !important; border: 3px solid #3F51B5 !important; }
.tile.mortgaged { opacity: 0.6; }
.tile.mortgaged::after {
  content: 'MORTGAGED'; position: absolute; top: 50%; left: 50%;
  transform: translate(-50%,-50%) rotate(-15deg);
  background: rgba(255,0,0,0.85); color: white; padding: 2px 4px;
  border-radius: 3px; font-weight: bold; font-size: 7px; white-space: nowrap;
}

#rollBtn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
#buyBtn { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
#endBtn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
#sellBtn { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; }
#buildBtn { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; }
#villaBtn { background: linear-gradient(135deg, #ff6a00 0%, #ee0979 100%); color: white; }
#bailBtn { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #333; }
#gojfBtn { background: linear-gradient(135deg, #f9ca24 0%, #f0932b 100%); color: white; }
#tradeBtn { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; }
#mortgageBtn { background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); color: white; }
#unmortgageBtn { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }

#board-center {
  grid-column: 2 / 11;
  grid-row: 2 / 11;
  display: flex;
  flex-direction: row;
  gap: 8px;
  padding: 14px;
  overflow: hidden;
  background: rgba(144, 238, 144, 0.12);
  border-radius: 6px;
}

#left-panel {
  width: 50%;
  display: flex;
  flex-direction: column;
  gap: 8px;
  overflow: hidden;
}

#right-panel {
  width: 50%;
  display: flex;
  flex-direction: column;
  gap: 8px;
  overflow: hidden;
}

#panel {
  background: rgba(255,255,255,0.95); padding: 8px 10px; border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: left; width: 100%; flex-shrink: 0;
}
#panel h3 { margin: 0 0 5px 0; font-size: 13px; color: #2c3e50; }

.player-card {
  display: flex; align-items: center; gap: 8px;
  padding: 5px 8px; margin: 3px 0; border-radius: 6px;
  border-left: 4px solid; transition: transform 0.2s;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  font-size: 12px;
}
.player-card.active { transform: translateX(4px); box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
.player-card .pc-name { font-weight: bold; min-width: 50px; }
.player-card .pc-money { color: #2e7d32; font-weight: bold; }
.player-card .pc-props { color: #666; font-size: 11px; }
.player-card .pc-jail { color: #e74c3c; font-size: 11px; font-weight: bold; }

#log {
  background: rgba(255,255,255,0.95); padding: 10px; border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: left;
  width: 100%; flex: 1; overflow-y: auto; font-size: 12px; min-height: 120px;
}

#tile-display {
  background: rgba(255,255,255,0.95); padding: 10px; border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: left;
  width: 100%; min-height: 150px; max-height: 200px; overflow-y: auto; font-size: 11px;
}
#tile-display h3 { margin: 0 0 8px 0; font-size: 13px; color: #2c3e50; }
#tile-display .tile-info { line-height: 1.4; }
#tile-display .tile-info strong { color: #2c3e50; }

#game-controls {
  background: rgba(255,255,255,0.95); padding: 10px; border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15); width: 100%; flex-shrink: 0;
  display: flex; flex-direction: column; gap: 6px;
}
#game-controls button {
  padding: 10px; font-size: 12px; font-weight: bold;
  border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
#game-controls button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
#game-controls button:active { transform: translateY(0); }

#saveBtn { background: linear-gradient(135deg, #20bf6b 0%, #26de81 100%); color: white; }
#loadBtn { background: linear-gradient(135deg, #4b7bec 0%, #3867d6 100%); color: white; }
#endGameBtn { background: linear-gradient(135deg, #fc5c65 0%, #eb3b5a 100%); color: white; }
#backMenuBtn { background: linear-gradient(135deg, #a55eea 0%, #8854d0 100%); color: white; }

.log-entry { padding: 6px; margin: 3px 0; border-radius: 4px; }
.log-expense { background: #ffebee; color: #c62828; }
.log-income { background: #e8f5e9; color: #2e7d32; }
.log-action { background: #e3f2fd; color: #1565c0; }

.modal {
  display: none; position: fixed; z-index: 1000; left: 0; top: 0;
  width: 100%; height: 100%; background: rgba(0,0,0,0.7); animation: fadeIn 0.3s;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.modal-content {
  background: white; margin: 5% auto; padding: 30px; border-radius: 16px;
  max-width: 700px; max-height: 80vh; overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4); animation: slideDown 0.3s ease;
}
@keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.modal-close {
  float: right; font-size: 32px; font-weight: bold; color: #aaa;
  cursor: pointer; line-height: 20px; transition: color 0.2s;
}
.modal-close:hover { color: #333; }

.trade-section { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
.trade-section h4 { margin-top: 0; color: #2c3e50; }

.property-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 10px; margin: 10px 0;
}

.property-item {
  padding: 10px; border: 2px solid #ddd; border-radius: 6px;
  cursor: pointer; transition: all 0.2s; background: white;
}
.property-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
.property-item.selected { border-color: #667eea; background: #e8eaf6; }

.money-input {
  width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ddd;
  border-radius: 6px; margin: 5px 0;
}

.trade-buttons { display: flex; gap: 10px; margin-top: 20px; }
.trade-buttons button {
  flex: 1; padding: 15px; font-size: 16px; font-weight: bold;
  border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;
}

.trade-btn-send { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
.trade-btn-cancel { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }

#auction-modal {
  display: none; position: fixed; z-index: 2000; left: 0; top: 0;
  width: 100%; height: 100%; background: rgba(0,0,0,0.85); animation: fadeIn 0.3s;
}

#auction-content {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  margin: 3% auto; padding: 0; border-radius: 20px; max-width: 600px;
  box-shadow: 0 10px 50px rgba(0,0,0,0.5); overflow: hidden; animation: slideDown 0.3s ease;
}

.auction-header {
  background: rgba(255,255,255,0.15); padding: 25px; text-align: center;
  color: white; backdrop-filter: blur(10px);
}
.auction-header h2 { margin: 0 0 10px 0; font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
.auction-tile-name { font-size: 20px; font-weight: bold; margin: 5px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
.auction-price { font-size: 16px; opacity: 0.9; }
.auction-current-bid {
  font-size: 32px; font-weight: bold; margin: 15px 0; padding: 15px;
  background: rgba(255,255,255,0.2); border-radius: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.auction-body { background: white; padding: 25px; }
.auction-timer { width: 100%; height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden; margin-bottom: 20px; }
#auction-timer-bar { height: 100%; background: linear-gradient(90deg, #27ae60, #f39c12); transition: width 1s linear; }

.auction-players-grid { display: flex; flex-direction: column; gap: 10px; margin: 20px 0; }
.auction-player-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 15px; background: #f8f9fa; border-radius: 8px;
  border: 2px solid transparent; transition: all 0.3s;
}
.auction-player-row.current-bidder { border-color: #e74c3c; background: #fff5f5; box-shadow: 0 0 15px rgba(231, 76, 60, 0.3); }
.auction-player-row.passed { opacity: 0.5; background: #ecf0f1; }
.auction-player-row.ai-row { background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); }

.auction-player-name { font-weight: bold; font-size: 16px; }
.auction-player-cash { font-size: 14px; color: #7f8c8d; margin-top: 3px; }
.auction-player-status { font-size: 14px; font-weight: bold; padding: 5px 10px; border-radius: 5px; background: #e8f5e9; color: #27ae60; }
.auction-player-status.out { background: #ffebee; color: #c62828; }

.auction-bid-btn {
  padding: 10px 20px; font-size: 14px; font-weight: bold; border: none;
  border-radius: 6px; cursor: pointer; transition: all 0.2s;
}
.auction-bid-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.btn-bid { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
.btn-bid:not(:disabled):hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(67, 233, 123, 0.4); }

.btn-pass { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
.btn-pass:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(240, 147, 251, 0.4); }

.auction-log {
  margin-top: 20px; padding: 15px; background: #ecf0f1; border-radius: 8px;
  max-height: 150px; overflow-y: auto; font-size: 13px; color: #2c3e50;
}
.auction-log-title { font-weight: bold; margin-bottom: 10px; color: #34495e; }

.trade-offer-modal {
  display: none; position: fixed; z-index: 3000; left: 0; top: 0;
  width: 100%; height: 100%; background: rgba(0,0,0,0.7);
}

.trade-offer-content {
  background: white; margin: 10% auto; padding: 30px; border-radius: 16px;
  max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); animation: slideDown 0.3s ease;
}

.trade-offer-section { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }

.trade-offer-buttons { display: flex; gap: 10px; margin-top: 20px; }
.trade-offer-buttons button {
  flex: 1; padding: 15px; font-size: 16px; font-weight: bold;
  border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;
}

.accept-btn { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
.reject-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
</style>
</head>
<body>

<div id="menu-screen">
  <h3>üé≤ Monopoly Classic</h3>
  <button class="menu-button ai" onclick="selectGameMode('ai')">
    ü§ñ Play vs AI
    <div class="subtitle">Challenge computer opponents</div>
  </button>
  <button class="menu-button online" onclick="selectGameMode('online')">
    üåê Play Online
    <div class="subtitle">Connect with friends remotely</div>
  </button>
  <button class="menu-button local" onclick="selectGameMode('local')">
    üë• Local Multiplayer
    <div class="subtitle">Pass and play on one device</div>
  </button>
  <button class="menu-button" onclick="loadGame()" style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); margin-top: 30px;">
    üìÇ Load Saved Game
    <div class="subtitle">Continue from where you left off</div>
  </button>
</div>

<div id="player-count-screen">
  <h3>How many players?</h3>
  <div>
    <button class="player-count-btn" onclick="startGame(2)">2</button>
    <button class="player-count-btn" onclick="startGame(3)">3</button>
    <button class="player-count-btn" onclick="startGame(4)">4</button>
  </div>
  <button class="menu-button" onclick="backToMenu()" style="margin-top: 30px;">‚Üê Back</button>
</div>

<div id="online-lobby">
  <h3>üåê Online Lobby</h3>
  <div class="lobby-section">
    <h4>Host a Game</h4>
    <button class="menu-button" onclick="createRoom()">Create Room</button>
    <div id="room-code-section" style="display:none; margin-top:15px;">
      <p><strong>Your Room Code:</strong></p>
      <div class="room-code-display" id="room-code">----</div>
      <p style="color:#7f8c8d; font-size:14px;">Share this code with your friend!</p>
    </div>
  </div>
  <div class="lobby-section">
    <h4>Join a Game</h4>
    <input type="text" class="lobby-input" id="join-code-input" placeholder="Enter Room Code" maxlength="4">
    <button class="menu-button" onclick="joinRoom()">Join Room</button>
  </div>
  <div id="connection-status" class="connection-status" style="display:none;">Connecting...</div>
  <button class="menu-button" onclick="backToMenu()" style="margin-top:20px;">‚Üê Back to Menu</button>
</div>

<div id="game-screen">
  <h2>Monopoly Classic</h2>
  <div id="status"></div>
  <div id="wrap">
    <div id="board">
      <div id="board-center">
        <div id="left-panel">
          <div id="panel"></div>
          <div class="controls">
            <div class="control-row">
              <button id="rollBtn" onclick="roll()">üé≤ Roll (Space)</button>
              <button id="buyBtn" onclick="buy()" disabled>üí∞ Buy (B)</button>
              <button id="endBtn" onclick="end()" disabled>‚úÖ End (Enter)</button>
            </div>
            <div class="control-row">
              <button id="sellBtn" onclick="toggleSellMode()">üè∑Ô∏è Sell (S)</button>
              <button id="buildBtn" onclick="enterBuildMode('house')">üè† House (H)</button>
              <button id="villaBtn" onclick="enterBuildMode('villa')">üè® Hotel (V)</button>
            </div>
            <div class="control-row">
              <button id="tradeBtn" onclick="openTradeMenu()">ü§ù Trade (T)</button>
              <button id="mortgageBtn" onclick="enterMortgageMode()">üè¶ Mortgage (M)</button>
              <button id="unmortgageBtn" onclick="enterUnmortgageMode()">üí≥ Unmtg (U)</button>
            </div>
            <button id="bailBtn" onclick="payBail()" style="display:none;">üí∏ Pay Bail $50 (B)</button>
            <button id="gojfBtn" onclick="useJailFreeCard()" style="display:none;">üÉè Use GOJF Card</button>
          </div>
          <div id="log"></div>
        </div>
        <div id="right-panel">
          <div id="tile-display">
            <h3>üìç Tile Information</h3>
            <div id="tile-info-content">Click on a tile to see details...</div>
          </div>
          <div id="game-controls">
            <button id="saveBtn" onclick="saveGame()">üíæ Save Game</button>
            <button id="loadBtn" onclick="loadGame()">üìÇ Load Game</button>
            <button id="endGameBtn" onclick="endGame()">üèÜ End & Declare Winner</button>
            <button id="backMenuBtn" onclick="backToMenu()">üîô Back to Menu</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="trade-modal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeTradeMenu()">&times;</span>
    <h2>ü§ù Propose Trade</h2>
    <div class="trade-section">
      <h4>Select Trading Partner</h4>
      <div id="trade-partner-list"></div>
    </div>
    <div class="trade-section">
      <h4>You Give</h4>
      <label>Money: $<input type="number" id="trade-give-money" class="money-input" value="0" min="0"></label>
      <div id="trade-give-properties" class="property-grid"></div>
    </div>
    <div class="trade-section">
      <h4>You Receive</h4>
      <label>Money: $<input type="number" id="trade-receive-money" class="money-input" value="0" min="0"></label>
      <div id="trade-receive-properties" class="property-grid"></div>
    </div>
    <div class="trade-buttons">
      <button class="trade-btn-send" onclick="sendTrade()">üì§ Send Offer</button>
      <button class="trade-btn-cancel" onclick="closeTradeMenu()">‚ùå Cancel</button>
    </div>
  </div>
</div>

<div id="trade-offer-modal" class="trade-offer-modal">
  <div class="trade-offer-content">
    <h2>ü§ù Trade Offer Received</h2>
    <p id="trade-offer-from"></p>
    <div class="trade-offer-section">
      <h4>They Give You:</h4>
      <div id="trade-offer-they-give"></div>
    </div>
    <div class="trade-offer-section">
      <h4>You Give Them:</h4>
      <div id="trade-offer-you-give"></div>
    </div>
    <div class="trade-offer-buttons">
      <button class="accept-btn" onclick="acceptTrade()">‚úÖ Accept</button>
      <button class="reject-btn" onclick="rejectTrade()">‚ùå Reject</button>
    </div>
  </div>
</div>

<div id="auction-modal">
  <div id="auction-content">
    <div class="auction-header">
      <h2>üî® AUCTION</h2>
      <div class="auction-tile-name" id="auction-tile-name">Property Name</div>
      <div class="auction-price" id="auction-market-price">Market Price: $XXX</div>
      <div class="auction-current-bid" id="auction-current-bid">Current Bid: $X</div>
    </div>
    <div class="auction-body">
      <div class="auction-timer" style="display:none;"><div id="auction-timer-bar"></div></div>
      <div id="auction-players-grid" class="auction-players-grid"></div>
      <div class="auction-log">
        <div class="auction-log-title">üìú Auction History</div>
        <div id="auction-log"></div>
      </div>
    </div>
  </div>
</div>

<script>
// Game state
const INTEREST_RATE = 0.1; // 10% interest on unmortgaging
let tiles = [];
let players = [];
let current = 0;
let rolled = false;
let diceRoll = [0, 0];
let sellingMode = false;
let buildMode = null;
let mortgageMode = false;
let unmortgageMode = false;
let gameMode = null;
let numPlayers = 0;
let logEntries = [];
let peer = null;
let conn = null;
let isHost = false;
let isMyTurn = false;
let myPlayerIndex = 0;
let roomCode = null;
let currentTrade = null;
let selectedPartner = null;
let tradeGiveProperties = [];
let tradeReceiveProperties = [];
let auction = null;

// Cryptographically secure random number [0, 1)
function secureRandom() {
  const arr = new Uint32Array(1);
  crypto.getRandomValues(arr);
  return arr[0] / (0xFFFFFFFF + 1);
}
// Secure integer in [1, max]
function secureRandInt(max) {
  return Math.floor(secureRandom() * max) + 1;
}

// Classic Monopoly board setup (40 tiles arranged 8x5)
const MONOPOLY_CLASSIC = [
  { name: 'GO', type: 'go' },
  { name: 'Mediterranean Ave', type: 'property', price: 60, rent: [2, 10, 30, 90, 160, 250], buildCost: 50, row: 0 },
  { name: 'Community Chest', type: 'luck' },
  { name: 'Baltic Ave', type: 'property', price: 60, rent: [4, 20, 60, 180, 320, 450], buildCost: 50, row: 0 },
  { name: 'Income Tax', type: 'tax', amount: 200 },
  { name: 'Reading Railroad', type: 'railroad', price: 200 },
  { name: 'Oriental Ave', type: 'property', price: 100, rent: [6, 30, 90, 270, 400, 550], buildCost: 50, row: 1 },
  { name: 'Chance', type: 'luck' },
  { name: 'Vermont Ave', type: 'property', price: 100, rent: [6, 30, 90, 270, 400, 550], buildCost: 50, row: 1 },
  { name: 'Connecticut Ave', type: 'property', price: 120, rent: [8, 40, 100, 300, 450, 600], buildCost: 50, row: 1 },
  { name: 'Jail/Visiting', type: 'jail' },
  { name: 'St. Charles Place', type: 'property', price: 140, rent: [10, 50, 150, 450, 625, 750], buildCost: 100, row: 2 },
  { name: 'Electric Company', type: 'utility', price: 150 },
  { name: 'States Ave', type: 'property', price: 140, rent: [10, 50, 150, 450, 625, 750], buildCost: 100, row: 2 },
  { name: 'Virginia Ave', type: 'property', price: 160, rent: [12, 60, 180, 500, 700, 900], buildCost: 100, row: 2 },
  { name: 'Pennsylvania RR', type: 'railroad', price: 200 },
  { name: 'St. James Place', type: 'property', price: 180, rent: [14, 70, 200, 550, 750, 950], buildCost: 100, row: 3 },
  { name: 'Community Chest', type: 'luck' },
  { name: 'Tennessee Ave', type: 'property', price: 180, rent: [14, 70, 200, 550, 750, 950], buildCost: 100, row: 3 },
  { name: 'New York Ave', type: 'property', price: 200, rent: [16, 80, 220, 600, 800, 1000], buildCost: 100, row: 3 },
  { name: 'Free Parking', type: 'freeparking' },
  { name: 'Kentucky Ave', type: 'property', price: 220, rent: [18, 90, 250, 700, 875, 1050], buildCost: 150, row: 4 },
  { name: 'Chance', type: 'luck' },
  { name: 'Indiana Ave', type: 'property', price: 220, rent: [18, 90, 250, 700, 875, 1050], buildCost: 150, row: 4 },
  { name: 'Illinois Ave', type: 'property', price: 240, rent: [20, 100, 300, 750, 925, 1100], buildCost: 150, row: 4 },
  { name: 'B&O Railroad', type: 'railroad', price: 200 },
  { name: 'Atlantic Ave', type: 'property', price: 260, rent: [22, 110, 330, 800, 975, 1150], buildCost: 150, row: 5 },
  { name: 'Ventnor Ave', type: 'property', price: 260, rent: [22, 110, 330, 800, 975, 1150], buildCost: 150, row: 5 },
  { name: 'Water Works', type: 'utility', price: 150 },
  { name: 'Marvin Gardens', type: 'property', price: 280, rent: [24, 120, 360, 850, 1025, 1200], buildCost: 150, row: 5 },
  { name: 'Go to Jail', type: 'gotojail' },
  { name: 'Pacific Ave', type: 'property', price: 300, rent: [26, 130, 390, 900, 1100, 1275], buildCost: 200, row: 6 },
  { name: 'North Carolina Ave', type: 'property', price: 300, rent: [26, 130, 390, 900, 1100, 1275], buildCost: 200, row: 6 },
  { name: 'Community Chest', type: 'luck' },
  { name: 'Pennsylvania Ave', type: 'property', price: 320, rent: [28, 150, 450, 1000, 1200, 1400], buildCost: 200, row: 6 },
  { name: 'Short Line RR', type: 'railroad', price: 200 },
  { name: 'Chance', type: 'luck' },
  { name: 'Park Place', type: 'property', price: 350, rent: [35, 175, 500, 1100, 1300, 1500], buildCost: 200, row: 7 },
  { name: 'Luxury Tax', type: 'tax', amount: 100 },
  { name: 'Boardwalk', type: 'property', price: 400, rent: [50, 200, 600, 1400, 1700, 2000], buildCost: 200, row: 7 }
];

function resetGame(numP = 2) {
  tiles = MONOPOLY_CLASSIC.map((template, i) => ({ ...template, o: -1, h: 0, v: 0, mortgaged: false }));
  const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12'];
  const names = ['Red', 'Blue', 'Green', 'Orange'];
  players = [];
  for (let i = 0; i < numP; i++) {
    players.push({ pos: 0, money: 1500, jailTurns: 0, color: colors[i], name: names[i], isAI: false, jailFreeCards: [] });
  }
  if (gameMode === 'ai') {
    for (let i = 1; i < numP; i++) {
      players[i].isAI = true;
      players[i].name += ' ü§ñ';
    }
  }
  current = 0;
  rolled = false;
  diceRoll = [0, 0];
  sellingMode = false;
  buildMode = null;
  mortgageMode = false;
  unmortgageMode = false;
  logEntries = [];
  chanceDeck = buildChanceDeck();
  communityDeck = buildCommunityDeck();
  draw();
  updatePanels();
  updateButtons();
  log('üéÆ Game started! Roll the dice.', 'log-action');
  if (gameMode === 'online') {
    isMyTurn = isHost ? (current === 0) : (current === 1);
  }
}

function selectGameMode(mode) {
  gameMode = mode;
  document.getElementById('menu-screen').style.display = 'none';
  if (mode === 'online') {
    document.getElementById('online-lobby').style.display = 'block';
  } else {
    document.getElementById('player-count-screen').style.display = 'block';
  }
}

function backToMenu() {
  gameMode = null;
  document.getElementById('menu-screen').style.display = 'block';
  document.getElementById('player-count-screen').style.display = 'none';
  document.getElementById('online-lobby').style.display = 'none';
  document.getElementById('game-screen').style.display = 'none';
  if (conn) conn.close();
  if (peer) peer.destroy();
  conn = null;
  peer = null;
}

function startGame(numP) {
  numPlayers = numP;
  document.getElementById('player-count-screen').style.display = 'none';
  document.getElementById('game-screen').style.display = 'block';
  resetGame(numP);
}

function generateRoomCode() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  const arr = new Uint8Array(4);
  crypto.getRandomValues(arr);
  return Array.from(arr).map(b => chars[b % chars.length]).join('');
}

function createRoom() {
  roomCode = generateRoomCode();
  peer = new Peer(roomCode, {
    config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
  });
  peer.on('open', (id) => {
    isHost = true;
    document.getElementById('room-code').textContent = roomCode;
    document.getElementById('room-code-section').style.display = 'block';
    showConnectionStatus('Waiting for player to join...', 'waiting');
  });
  peer.on('connection', (connection) => {
    conn = connection;
    setupConnection();
    showConnectionStatus('Player connected! Starting game...', 'connected');
    setTimeout(() => {
      document.getElementById('online-lobby').style.display = 'none';
      document.getElementById('game-screen').style.display = 'block';
      myPlayerIndex = 0;
      startGame(2);
      sendAction('sync', { tiles: tiles, players: players, current: current });
    }, 1000);
  });
  peer.on('error', (err) => {
    showConnectionStatus('Connection error: ' + err.message, 'error');
  });
}

function joinRoom() {
  const code = document.getElementById('join-code-input').value.toUpperCase().trim();
  if (code.length !== 4) {
    showConnectionStatus('Please enter a 4-character room code', 'error');
    return;
  }
  peer = new Peer({ config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] } });
  peer.on('open', () => {
    conn = peer.connect(code);
    isHost = false;
    myPlayerIndex = 1;
    setupConnection();
    showConnectionStatus('Connecting to host...', 'waiting');
  });
  peer.on('error', (err) => {
    showConnectionStatus('Failed to join room: ' + err.message, 'error');
  });
}

function setupConnection() {
  conn.on('open', () => {
    if (!isHost) {
      showConnectionStatus('Connected! Waiting for game to start...', 'connected');
    }
  });
  conn.on('data', (data) => {
    handleRemoteAction(data);
  });
  conn.on('close', () => {
    showConnectionStatus('Connection lost', 'error');
    alert('Connection to other player lost. Returning to menu.');
    backToMenu();
  });
}

function showConnectionStatus(message, type) {
  const statusDiv = document.getElementById('connection-status');
  statusDiv.textContent = message;
  statusDiv.style.display = 'block';
  statusDiv.className = 'connection-status status-' + type;
}

function sendAction(action, data = {}) {
  if (!conn || gameMode !== 'online') return;
  conn.send({ action: action, data: data });
}

function handleRemoteAction(message) {
  const { action, data } = message;
  switch (action) {
    case 'sync':
      tiles = data.tiles;
      players = data.players;
      current = data.current;
      document.getElementById('online-lobby').style.display = 'none';
      document.getElementById('game-screen').style.display = 'block';
      draw();
      updatePanels();
      updateButtons();
      break;
    case 'roll':
      diceRoll = data.dice;
      rolled = true;
      movePlayer(data.newPos);
      landOnTile();
      draw();
      updatePanels();
      updateButtons();
      break;
    case 'buy':
      buyProperty();
      break;
    case 'end':
      switchTurn();
      break;
    case 'sell':
      tiles[data.tileIndex].o = -1;
      tiles[data.tileIndex].mortgaged = false;
      players[data.playerIndex].money += data.amount;
      draw();
      updatePanels();
      break;
    case 'sell-building':
      if (data.buildingType === 'villa') {
        tiles[data.tileIndex].v--;
        tiles[data.tileIndex].h = 4;
      } else {
        tiles[data.tileIndex].h--;
      }
      players[data.playerIndex].money += data.amount;
      draw();
      updatePanels();
      break;
    case 'build':
      if (data.buildType === 'house') {
        tiles[data.tileIndex].h++;
      } else {
        tiles[data.tileIndex].v++;
        tiles[data.tileIndex].h = 0;
      }
      players[data.playerIndex].money -= data.cost;
      draw();
      updatePanels();
      break;
    case 'mortgage':
      tiles[data.tileIndex].mortgaged = true;
      players[data.playerIndex].money += data.amount;
      draw();
      updatePanels();
      break;
    case 'unmortgage':
      tiles[data.tileIndex].mortgaged = false;
      players[data.playerIndex].money -= data.amount;
      draw();
      updatePanels();
      break;
  }
}

// Map tile index (0-39) to [col, row] on an 11x11 grid (0-indexed internally, displayed 1-indexed)
// Classic Monopoly: 11 tiles per side, 4 corners shared = 40 tiles total
// Tile 0 (GO)          = bottom-right corner  (col 10, row 10)
// Tiles 1-9            = bottom row, right‚Üíleft (col 9..1, row 10)
// Tile 10 (Jail)       = bottom-left corner   (col 0, row 10)
// Tiles 11-19          = left col, bottom‚Üítop  (col 0, row 9..1)
// Tile 20 (FreeParking)= top-left corner       (col 0, row 0)
// Tiles 21-29          = top row, left‚Üíright   (col 1..9, row 0)
// Tile 30 (GoToJail)   = top-right corner      (col 10, row 0)
// Tiles 31-39          = right col, top‚Üíbottom (col 10, row 1..9)
function tileGridPos(i) {
  if (i === 0)  return [10, 10]; // GO
  if (i <= 9)   return [10 - i, 10]; // bottom row right‚Üíleft
  if (i === 10) return [0, 10]; // Jail
  if (i <= 19)  return [0, 10 - (i - 10)]; // left col bottom‚Üítop
  if (i === 20) return [0, 0]; // Free Parking
  if (i <= 29)  return [i - 20, 0]; // top row left‚Üíright
  if (i === 30) return [10, 0]; // Go to Jail
  return [10, i - 30]; // right col top‚Üíbottom
}

function draw() {
  let board = document.getElementById('board');
  board.style.gridTemplateColumns = '';
  board.style.gridTemplateRows = '';
  board.style.width = '';
  board.style.height = '';
  // Remove only tile divs, preserve #board-center
  Array.from(board.children).forEach(child => {
    if (child.id !== 'board-center') child.remove();
  });
  for (let i = 0; i < tiles.length; i++) {
    let t = tiles[i];
    let div = document.createElement('div');
    div.className = 'tile';
    div.dataset.index = i;
    if (t.mortgaged) div.classList.add('mortgaged');
    if (t.type === 'go') div.classList.add('go-tile');
    else if (t.type === 'jail') div.classList.add('jail-tile');
    else if (t.type === 'gotojail') div.classList.add('gotojail-tile');
    else if (t.type === 'freeparking') div.classList.add('freeparking-tile');
    else if (t.type === 'luck') div.classList.add('luck-tile');
    else if (t.type === 'tax') div.classList.add('tax-tile');
    else if (t.type === 'railroad') div.classList.add('rail-tile');
    else if (t.type === 'utility') div.classList.add('utility-tile');
    if (t.type === 'property' && t.row !== undefined) {
      let hdr = document.createElement('div');
      hdr.className = 'tile-header row-' + t.row;
      hdr.innerHTML = '<span class="tile-num">' + i + '</span>';
      div.appendChild(hdr);
    } else {
      let hdr = document.createElement('div');
      hdr.className = 'tile-header';
      hdr.textContent = t.name;
      div.appendChild(hdr);
    }

    if (t.type === 'property' || t.type === 'railroad' || t.type === 'utility') {
      // Price
      let priceDiv = document.createElement('div');
      priceDiv.className = 'tile-price';
      priceDiv.textContent = '$' + t.price;
      div.appendChild(priceDiv);

      // Compact rent table for properties: 4 rows √ó 4 cols (label+value pairs)
      if (t.type === 'property' && t.rent) {
        let activeLevel = t.v > 0 ? 5 : t.h > 0 ? t.h : 0;
        let table = document.createElement('table');
        table.className = 'rent-table';
        const entries = [
          { label: 'B',  idx: 0 },
          { label: '1H', idx: 1 },
          { label: '2H', idx: 2 },
          { label: '3H', idx: 3 },
          { label: '4H', idx: 4 },
          { label: 'üè®', idx: 5 },
        ];
        // Build 3 rows of 2 entries each (4 columns total: label+value, label+value)
        for (let row = 0; row < 3; row++) {
          let tr = document.createElement('tr');
          for (let col = 0; col < 2; col++) {
            let entryIdx = row * 2 + col;
            if (entryIdx < entries.length) {
              let entry = entries[entryIdx];
              let tdL = document.createElement('td');
              tdL.className = 'rlabel' + (entry.idx === activeLevel ? ' active-rent' : '');
              tdL.textContent = entry.label;
              let tdV = document.createElement('td');
              tdV.className = 'rval' + (entry.idx === activeLevel ? ' active-rent' : '');
              tdV.textContent = '$' + t.rent[entry.idx];
              tr.appendChild(tdL);
              tr.appendChild(tdV);
            }
          }
          table.appendChild(tr);
        }
        div.appendChild(table);
      }
      
      // Display rent info for railroads and utilities in table format
      if (t.type === 'railroad') {
        let table = document.createElement('table');
        table.className = 'rent-table';
        table.style.cssText = 'margin-top:2px;';
        const railCount = tiles.filter(tile => tile.type === 'railroad' && tile.o === t.o).length;
        
        let tr1 = document.createElement('tr');
        ['1RR', '2RR'].forEach((label, idx) => {
          let tdL = document.createElement('td');
          tdL.className = 'rlabel' + (railCount === idx + 1 ? ' active-rent' : '');
          tdL.style.color = '#FFD700';
          tdL.textContent = label;
          let tdV = document.createElement('td');
          tdV.className = 'rval' + (railCount === idx + 1 ? ' active-rent' : '');
          tdV.style.color = '#FFD700';
          tdV.style.fontSize = '7px';
          tdV.textContent = '$' + [25, 50][idx];
          tr1.appendChild(tdL);
          tr1.appendChild(tdV);
        });
        table.appendChild(tr1);
        
        let tr2 = document.createElement('tr');
        ['3RR', '4RR'].forEach((label, idx) => {
          let tdL = document.createElement('td');
          tdL.className = 'rlabel' + (railCount === idx + 3 ? ' active-rent' : '');
          tdL.style.color = '#FFD700';
          tdL.textContent = label;
          let tdV = document.createElement('td');
          tdV.className = 'rval' + (railCount === idx + 3 ? ' active-rent' : '');
          tdV.style.color = '#FFD700';
          tdV.style.fontSize = '7px';
          tdV.textContent = '$' + [100, 200][idx];
          tr2.appendChild(tdL);
          tr2.appendChild(tdV);
        });
        table.appendChild(tr2);
        div.appendChild(table);
      }
      
      if (t.type === 'utility') {
        let table = document.createElement('table');
        table.className = 'rent-table';
        table.style.cssText = 'margin-top:2px;';
        const utilCount = tiles.filter(tile => tile.type === 'utility' && tile.o === t.o).length;
        
        let tr = document.createElement('tr');
        ['1Util', '2Util'].forEach((label, idx) => {
          let tdL = document.createElement('td');
          tdL.className = 'rlabel' + (utilCount === idx + 1 ? ' active-rent' : '');
          tdL.style.color = '#00FFFF';
          tdL.textContent = label;
          let tdV = document.createElement('td');
          tdV.className = 'rval' + (utilCount === idx + 1 ? ' active-rent' : '');
          tdV.style.color = '#00FFFF';
          tdV.style.fontSize = '7px';
          tdV.textContent = [4, 10][idx] + '√óüé≤';
          tr.appendChild(tdL);
          tr.appendChild(tdV);
        });
        table.appendChild(tr);
        div.appendChild(table);
      }
    }

    // Buildings
    if (t.h > 0 || t.v > 0) {
      let buildDiv = document.createElement('div');
      buildDiv.style.display = 'flex'; buildDiv.style.flexWrap = 'wrap'; buildDiv.style.gap = '1px';
      for (let j = 0; j < t.h; j++) {
        let house = document.createElement('div');
        house.className = 'house'; house.title = 'House';
        buildDiv.appendChild(house);
      }
      for (let j = 0; j < t.v; j++) {
        let villa = document.createElement('div');
        villa.className = 'villa'; villa.title = 'Hotel';
        buildDiv.appendChild(villa);
      }
      div.appendChild(buildDiv);
    }

    // Bottom row: owner dot on left, pawns on right
    let bottomDiv = document.createElement('div');
    bottomDiv.className = 'tile-bottom';

    let ownerSlot = document.createElement('div');
    if (t.o >= 0) {
      let dot = document.createElement('div');
      dot.className = 'owner-dot';
      dot.style.background = players[t.o].color;
      dot.title = players[t.o].name;
      dot.textContent = players[t.o].name[0];
      ownerSlot.appendChild(dot);
    }
    bottomDiv.appendChild(ownerSlot);

    let pawnsArea = document.createElement('div');
    pawnsArea.className = 'pawns-area';
    let pawnsHere = players.filter(p => p.pos === i);
    pawnsHere.forEach(p => {
      let pawn = document.createElement('div');
      pawn.className = 'pawn';
      pawn.style.background = p.color;
      pawn.title = p.name;
      pawnsArea.appendChild(pawn);
    });
    bottomDiv.appendChild(pawnsArea);
    div.appendChild(bottomDiv);
    
    // C. Add general tile click handler for tile display (unless in specific mode)
    let modeHandlerSet = false;
    if (sellingMode && t.o === current) {
      div.classList.add('sellable');
      div.onclick = () => sellProperty(i);
      modeHandlerSet = true;
    }
    if (buildMode && canBuildOn(i)) {
      div.classList.add('buildable');
      div.onclick = () => buildOnProperty(i);
      modeHandlerSet = true;
    }
    if (mortgageMode && t.o === current && (t.type === 'property' || t.type === 'railroad' || t.type === 'utility') && !t.mortgaged && t.h === 0 && t.v === 0) {
      div.classList.add('mortgageable');
      div.onclick = () => mortgageProperty(i);
      modeHandlerSet = true;
    }
    if (unmortgageMode && t.o === current && (t.type === 'property' || t.type === 'railroad' || t.type === 'utility') && t.mortgaged) {
      div.classList.add('unmortgageable');
      div.onclick = () => unmortgageProperty(i);
      modeHandlerSet = true;
    }
    
    // If no mode-specific handler, add general tile info handler
    if (!modeHandlerSet) {
      div.onclick = () => displayTileInfo(i);
      div.style.cursor = 'pointer';
    }
    
    // Position tile on the 10√ó10 perimeter grid
    let [col, row] = tileGridPos(i);
    div.style.gridColumn = (col + 1) + '';
    div.style.gridRow = (row + 1) + '';

    board.appendChild(div);
  }
}

function roll() {
  if (rolled) {
    log('‚ö†Ô∏è Already rolled this turn!', 'log-action');
    return;
  }
  if (gameMode === 'online' && !isMyTurn) {
    log('‚ö†Ô∏è Wait for your turn!', 'log-action');
    return;
  }
  let p = players[current];
  if (p.jailTurns > 0) {
    diceRoll = [secureRandInt(6), secureRandInt(6)];
    rolled = true;
    if (diceRoll[0] === diceRoll[1]) {
      p.jailTurns = 0;
      log(`üé≤ ${p.name} rolled doubles [${diceRoll[0]}, ${diceRoll[1]}] and escaped jail!`, 'log-action');
      movePlayer(p.pos + diceRoll[0] + diceRoll[1]);
      landOnTile();
    } else {
      p.jailTurns--;
      if (p.jailTurns === 0) {
        // Third turn failed - must pay $50 and move
        p.money -= 50;
        log(`üé≤ ${p.name} rolled [${diceRoll[0]}, ${diceRoll[1]}] ‚Äî Failed 3rd attempt. Must pay $50 fine and move.`, 'log-expense');
        beep(300);
        movePlayer(p.pos + diceRoll[0] + diceRoll[1]);
        landOnTile();
        checkBankruptcy();
      } else {
        log(`üé≤ ${p.name} rolled [${diceRoll[0]}, ${diceRoll[1]}] ‚Äî ${p.jailTurns} turns left in jail`, 'log-action');
      }
    }
    draw();
    updatePanels();
    updateButtons();
    return;
  }
  diceRoll = [secureRandInt(6), secureRandInt(6)];
  rolled = true;
  let total = diceRoll[0] + diceRoll[1];
  beep(400);
  let newPos = (p.pos + total) % tiles.length;
  if (gameMode === 'online' && isMyTurn) {
    sendAction('roll', { dice: diceRoll, newPos: newPos });
  }
  movePlayer(newPos);
  landOnTile();
  draw();
  updatePanels();
  updateButtons();
  if (p.isAI) {
    setTimeout(() => aiTakeTurn(), 1500);
  }
}

function movePlayer(newPos) {
  let p = players[current];
  if (newPos < p.pos) {
    p.money += 200;
    log(`üí∞ ${p.name} passed GO ‚Äî Collect $200!`, 'log-income');
    beep(600);
  }
  p.pos = newPos;
}

function landOnTile() {
  let p = players[current];
  let t = tiles[p.pos];
  switch (t.type) {
    case 'go':
      p.money += 200;
      log(`üèÅ ${p.name} landed on GO ‚Äî Collect extra $200!`, 'log-income');
      beep(700);
      break;
    case 'property':
    case 'railroad':
    case 'utility':
      if (t.o === -1) {
        log(`üè† ${t.name} is available for $${t.price}`, 'log-action');
      } else if (t.o === current) {
        log(`üòä ${p.name} landed on own property`, 'log-action');
      } else if (t.mortgaged) {
        log(`üè¶ ${t.name} is mortgaged ‚Äî No rent due`, 'log-action');
      } else {
        let rent = calcRent(p.pos);
        p.money -= rent;
        players[t.o].money += rent;
        log(`üí∏ ${p.name} paid $${rent} rent to ${players[t.o].name}`, 'log-expense');
        beep(300);
        checkBankruptcy();
      }
      break;
    case 'luck':
      handleLuck();
      break;
    case 'tax':
      p.money -= t.amount;
      log(`üí∏ ${p.name} paid $${t.amount} in taxes`, 'log-expense');
      beep(300);
      checkBankruptcy();
      break;
    case 'gotojail':
      p.pos = 10;
      p.jailTurns = 3;
      log(`üöì ${p.name} sent to JAIL!`, 'log-expense');
      beep(200);
      break;
    case 'freeparking':
      log(`üÖøÔ∏è ${p.name} resting at Free Parking`, 'log-action');
      break;
    case 'jail':
      log(`üëÄ ${p.name} is just visiting Jail`, 'log-action');
      break;
  }
}

function calcRent(tileIndex) {
  let t = tiles[tileIndex];
  if (t.type === 'utility') {
    let owned = tiles.filter(tile => tile.type === 'utility' && tile.o === t.o).length;
    let multiplier = owned === 2 ? 10 : 4;
    return (diceRoll[0] + diceRoll[1]) * multiplier;
  }
  if (t.type === 'railroad') {
    let owned = tiles.filter(tile => tile.type === 'railroad' && tile.o === t.o).length;
    return [25, 50, 100, 200][owned - 1];
  }
  if (t.v > 0) return t.rent[5];
  if (t.h > 0) return t.rent[t.h];
  let sameRow = tiles.filter(tile => tile.type === 'property' && tile.row === t.row);
  let monopoly = sameRow.every(tile => tile.o === t.o);
  return monopoly ? t.rent[0] * 2 : t.rent[0];
}

// ‚îÄ‚îÄ Chance & Community Chest ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Shuffled decks; reshuffled when exhausted. GOJF cards are held by a player
// and removed from the deck until returned.

let chanceDeck = [];
let communityDeck = [];

function buildChanceDeck() {
  return shuffleDeck([
    { id: 'ch_go',       msg: 'üé≤ Chance: Advance to GO ‚Äî Collect $200!',              action: 'advance', dest: 0 },
    { id: 'ch_illinois', msg: 'üé≤ Chance: Advance to Illinois Ave.',                   action: 'advance', dest: 24 },
    { id: 'ch_stcharles',msg: 'üé≤ Chance: Advance to St. Charles Place.',              action: 'advance', dest: 11 },
    { id: 'ch_railroad1',msg: 'üé≤ Chance: Advance to nearest Railroad.',               action: 'nearest_railroad' },
    { id: 'ch_railroad2',msg: 'üé≤ Chance: Advance to nearest Railroad (√ó2 rent).',    action: 'nearest_railroad', doubleRent: true },
    { id: 'ch_utility',  msg: 'üé≤ Chance: Advance to nearest Utility (10√ó dice).',    action: 'nearest_utility' },
    { id: 'ch_dividend', msg: 'üé≤ Chance: Bank pays you dividend ‚Äî Collect $50!',      action: 'money', amount: 50 },
    { id: 'ch_gojf',     msg: 'üé≤ Chance: Get Out of Jail Free card!',                action: 'gojf' },
    { id: 'ch_back3',    msg: 'üé≤ Chance: Go Back 3 Spaces.',                         action: 'back3' },
    { id: 'ch_jail',     msg: 'üé≤ Chance: Go to Jail!',                               action: 'jail' },
    { id: 'ch_repairs',  msg: 'üé≤ Chance: Make general repairs ‚Äî $25/house, $100/hotel.', action: 'repairs', houseCost: 25, hotelCost: 100 },
    { id: 'ch_fine',     msg: 'üé≤ Chance: Speeding fine ‚Äî Pay $15.',                  action: 'money', amount: -15 },
    { id: 'ch_reading',  msg: 'üé≤ Chance: Take a trip to Reading Railroad.',          action: 'advance', dest: 5 },
    { id: 'ch_boardwalk',msg: 'üé≤ Chance: Advance to Boardwalk.',                     action: 'advance', dest: 39 },
    { id: 'ch_chairs',   msg: 'üé≤ Chance: Elected chairman ‚Äî Pay each player $50.',   action: 'chairman' },
    { id: 'ch_loan',     msg: 'üé≤ Chance: Building loan matures ‚Äî Collect $150!',     action: 'money', amount: 150 },
  ]);
}

function buildCommunityDeck() {
  return shuffleDeck([
    { id: 'cc_go',       msg: 'üì¶ Community Chest: Advance to GO ‚Äî Collect $200!',    action: 'advance', dest: 0 },
    { id: 'cc_bank',     msg: 'üì¶ Community Chest: Bank error in your favor ‚Äî Collect $200!', action: 'money', amount: 200 },
    { id: 'cc_doctor',   msg: 'üì¶ Community Chest: Doctor\'s fee ‚Äî Pay $50.',         action: 'money', amount: -50 },
    { id: 'cc_stock',    msg: 'üì¶ Community Chest: From sale of stock ‚Äî Collect $50!', action: 'money', amount: 50 },
    { id: 'cc_gojf',     msg: 'üì¶ Community Chest: Get Out of Jail Free card!',       action: 'gojf' },
    { id: 'cc_jail',     msg: 'üì¶ Community Chest: Go to Jail!',                      action: 'jail' },
    { id: 'cc_opera',    msg: 'üì¶ Community Chest: Grand Opera Night ‚Äî Collect $50 from each player!', action: 'collect_each', amount: 50 },
    { id: 'cc_holiday',  msg: 'üì¶ Community Chest: Holiday fund matures ‚Äî Collect $100!', action: 'money', amount: 100 },
    { id: 'cc_income',   msg: 'üì¶ Community Chest: Income tax refund ‚Äî Collect $20!', action: 'money', amount: 20 },
    { id: 'cc_birthday', msg: 'üì¶ Community Chest: It\'s your birthday ‚Äî Collect $10 from each player!', action: 'collect_each', amount: 10 },
    { id: 'cc_life',     msg: 'üì¶ Community Chest: Life insurance matures ‚Äî Collect $100!', action: 'money', amount: 100 },
    { id: 'cc_hospital', msg: 'üì¶ Community Chest: Hospital fees ‚Äî Pay $100.',        action: 'money', amount: -100 },
    { id: 'cc_school',   msg: 'üì¶ Community Chest: School fees ‚Äî Pay $150.',          action: 'money', amount: -150 },
    { id: 'cc_consult',  msg: 'üì¶ Community Chest: Receive consultancy fee ‚Äî Collect $25!', action: 'money', amount: 25 },
    { id: 'cc_repairs',  msg: 'üì¶ Community Chest: Street repairs ‚Äî $40/house, $115/hotel.', action: 'repairs', houseCost: 40, hotelCost: 115 },
    { id: 'cc_beauty',   msg: 'üì¶ Community Chest: Won second prize in beauty contest ‚Äî Collect $10!', action: 'money', amount: 10 },
    { id: 'cc_inherit',  msg: 'üì¶ Community Chest: You inherit $100!',                action: 'money', amount: 100 },
  ]);
}

function shuffleDeck(deck) {
  // Fisher-Yates with crypto
  for (let i = deck.length - 1; i > 0; i--) {
    const arr = new Uint32Array(1);
    crypto.getRandomValues(arr);
    const j = arr[0] % (i + 1);
    [deck[i], deck[j]] = [deck[j], deck[i]];
  }
  return deck;
}

function drawCard(deckType) {
  let deck = deckType === 'chance' ? chanceDeck : communityDeck;
  if (deck.length === 0) {
    // Reshuffle, but don't include GOJF cards currently held by players
    const heldCards = players.flatMap(p => p.jailFreeCards || []);
    let newDeck = deckType === 'chance' ? buildChanceDeck() : buildCommunityDeck();
    deck = newDeck.filter(c => !heldCards.includes(c.id));
    if (deckType === 'chance') chanceDeck = deck; else communityDeck = deck;
  }
  const card = deck.shift();
  if (deckType === 'chance') chanceDeck = deck; else communityDeck = deck;
  return card;
}

function handleCard(deckType) {
  let card = drawCard(deckType);
  let p = players[current];
  log(card.msg, 'log-action');
  beep(550);

  switch (card.action) {
    case 'money':
      p.money += card.amount;
      log(card.amount >= 0 ? `üí∞ +$${card.amount}` : `üí∏ -$${Math.abs(card.amount)}`,
          card.amount >= 0 ? 'log-income' : 'log-expense');
      checkBankruptcy();
      break;

    case 'advance': {
      const oldPos = p.pos;
      const newPos = card.dest;
      if (newPos < oldPos) {        // passed GO
        p.money += 200;
        log(`üí∞ ${p.name} passed GO ‚Äî Collect $200!`, 'log-income');
      }
      p.pos = newPos;
      landOnTile();
      break;
    }

    case 'nearest_railroad': {
      const railroads = [5, 15, 25, 35];
      let nearest = railroads.find(r => r > p.pos) || railroads[0];
      if (nearest <= p.pos) { p.money += 200; log(`üí∞ ${p.name} passed GO ‚Äî Collect $200!`, 'log-income'); }
      p.pos = nearest;
      if (card.doubleRent) {
        let t = tiles[nearest];
        if (t.o >= 0 && t.o !== current && !t.mortgaged) {
          let rent = calcRent(nearest) * 2;
          p.money -= rent; players[t.o].money += rent;
          log(`üí∏ ${p.name} paid DOUBLE rent $${rent} to ${players[t.o].name}`, 'log-expense');
          checkBankruptcy();
        }
      } else { landOnTile(); }
      break;
    }

    case 'nearest_utility': {
      const utilities = [12, 28];
      let nearest = utilities.find(u => u > p.pos) || utilities[0];
      if (nearest <= p.pos) { p.money += 200; log(`üí∞ ${p.name} passed GO ‚Äî Collect $200!`, 'log-income'); }
      p.pos = nearest;
      let t = tiles[nearest];
      if (t.o >= 0 && t.o !== current && !t.mortgaged) {
        let rent = (diceRoll[0] + diceRoll[1]) * 10;  // Chance: always 10√ó dice
        p.money -= rent; players[t.o].money += rent;
        log(`üí∏ ${p.name} paid $${rent} (10√ó dice) to ${players[t.o].name}`, 'log-expense');
        checkBankruptcy();
      }
      break;
    }

    case 'gojf':
      if (!p.jailFreeCards) p.jailFreeCards = [];
      p.jailFreeCards.push(card.id);
      log(`üÉè ${p.name} keeps the Get Out of Jail Free card!`, 'log-income');
      break;

    case 'back3': {
      let newPos = (p.pos - 3 + 40) % 40;
      p.pos = newPos;
      landOnTile();
      break;
    }

    case 'jail':
      p.pos = 10;
      p.jailTurns = 3;
      log(`üöì ${p.name} sent to JAIL!`, 'log-expense');
      beep(200);
      break;

    case 'repairs': {
      let houses = tiles.filter(t => t.o === current).reduce((s, t) => s + t.h, 0);
      let hotels = tiles.filter(t => t.o === current).reduce((s, t) => s + t.v, 0);
      let cost = houses * card.houseCost + hotels * card.hotelCost;
      p.money -= cost;
      log(`üî® Repairs: ${houses} houses √ó $${card.houseCost} + ${hotels} hotels √ó $${card.hotelCost} = $${cost}`, 'log-expense');
      checkBankruptcy();
      break;
    }

    case 'chairman':
      players.forEach((other, idx) => {
        if (idx !== current) { other.money += 50; p.money -= 50; }
      });
      log(`üí∏ ${p.name} paid $50 to each player as chairman`, 'log-expense');
      checkBankruptcy();
      break;

    case 'collect_each':
      players.forEach((other, idx) => {
        if (idx !== current) { other.money -= card.amount; p.money += card.amount; }
      });
      log(`üí∞ ${p.name} collected $${card.amount} from each player`, 'log-income');
      checkBankruptcy();
      break;
  }
}

function handleLuck() {
  // Determine whether this is a Chance or Community Chest tile
  let t = tiles[players[current].pos];
  // Chance tiles: 7, 22, 36 ‚Äî Community Chest: 2, 17, 33
  const chanceTiles = [7, 22, 36];
  if (chanceTiles.includes(players[current].pos)) {
    handleCard('chance');
  } else {
    handleCard('community');
  }
}


function buy() {
  let p = players[current];
  let t = tiles[p.pos];
  if (t.type !== 'property' && t.type !== 'railroad' && t.type !== 'utility') {
    log('‚ö†Ô∏è Cannot buy this tile', 'log-action');
    return;
  }
  if (t.o !== -1) {
    log('‚ö†Ô∏è Property already owned', 'log-action');
    return;
  }
  if (p.money < t.price) {
    log('‚ö†Ô∏è Not enough money!', 'log-expense');
    return;
  }
 
  buyProperty();
}

function buyProperty() {
  let p = players[current];
  let t = tiles[p.pos];
  p.money -= t.price;
  t.o = current;
  log(`üè† ${p.name} bought ${t.name} for $${t.price}`, 'log-income');
  beep(600);
  if (gameMode === 'online' && isMyTurn) {
    sendAction('buy');
  }
  draw();
  updatePanels();
  updateButtons();
  checkBankruptcy();
}

function end() {
  if (!rolled && players[current].jailTurns === 0) {
    log('‚ö†Ô∏è Must roll first!', 'log-action');
    return;
  }
  let p = players[current];
  let t = tiles[p.pos];
  if (rolled && !p.isAI && (t.type === 'property' || t.type === 'railroad' || t.type === 'utility') && t.o === -1) {
    log(`üî® ${t.name} not purchased ‚Äî Starting auction!`, 'log-action');
    startAuction(p.pos);
    return;
  }
  let inJail = p.jailTurns > 0;
  if (sellingMode) toggleSellMode();
  if (buildMode) exitBuildMode();
  if (mortgageMode) exitMortgageMode();
  if (unmortgageMode) exitUnmortgageMode();
  if (!inJail) {
    log(`‚úÖ ${p.name} ended turn`, 'log-action');
  }
  rolled = false;
  if (gameMode === 'online' && isMyTurn) {
    sendAction('end');
  }
  switchTurn();
}

function switchTurn() {
  current = (current + 1) % players.length;
  if (gameMode === 'online') {
    isMyTurn = (current === myPlayerIndex);
  }
  draw();
  updatePanels();
  updateButtons();
  if (players[current].isAI) {
    setTimeout(() => {
      roll();
    }, 1000);
  }
}

function payBail() {
  let p = players[current];
  if (p.jailTurns === 0) {
    log('‚ö†Ô∏è Not in jail!', 'log-action');
    return;
  }
  if (p.money < 50) {
    log('‚ö†Ô∏è Not enough money for bail!', 'log-expense');
    return;
  }
  p.money -= 50;
  p.jailTurns = 0;
  log(`üîì ${p.name} paid $50 bail and left jail`, 'log-expense');
  beep(500);
  draw();
  updatePanels();
  updateButtons();
}

function useJailFreeCard() {
  let p = players[current];
  if (p.jailTurns === 0) { log('‚ö†Ô∏è Not in jail!', 'log-action'); return; }
  if (!p.jailFreeCards || p.jailFreeCards.length === 0) { log('‚ö†Ô∏è No Get Out of Jail Free card!', 'log-action'); return; }
  const cardId = p.jailFreeCards.pop();
  p.jailTurns = 0;
  // Return card to the appropriate deck (will be reshuffled in)
  log(`üÉè ${p.name} used Get Out of Jail Free card and is released!`, 'log-income');
  beep(600);
  draw();
  updatePanels();
  updateButtons();
}

function toggleSellMode() {
  sellingMode = !sellingMode;
  if (buildMode) buildMode = null;
  if (sellingMode) {
    log('üè∑Ô∏è Sell Mode: Click a property you own to sell it', 'log-action');
  } else {
    log('‚ùå Sell Mode cancelled', 'log-action');
  }
  draw();
  updateButtons();
}

function sellProperty(tileIndex) {
  let t = tiles[tileIndex];
  let p = players[current];
  if (t.o !== current) {
    log('‚ö†Ô∏è You don\'t own this property', 'log-action');
    return;
  }
  
  // Even building rule for selling: can only sell from properties with the MOST buildings
  if (t.type === 'property' && (t.h > 0 || t.v > 0)) {
    let sameRow = tiles.filter(tile => tile.type === 'property' && tile.row === t.row && tile.o === current);
    let maxHouses = Math.max(...sameRow.map(tile => tile.h + (tile.v * 5))); // Count hotels as 5
    let currentHouses = t.h + (t.v * 5);
    if (currentHouses < maxHouses) {
      log('‚ö†Ô∏è Even building rule: Must sell from properties with the most buildings first!', 'log-action');
      return;
    }
  }
  
  // If there are buildings, sell one building at a time
  if (t.v > 0) {
    // Sell one hotel first
    let sellPrice = Math.floor(t.buildCost * 0.5);
    t.v--;
    t.h = 4; // Hotel downgrades to 4 houses
    p.money += sellPrice;
    log(`üíµ ${p.name} sold 1 hotel on ${t.name} for $${sellPrice} (downgraded to 4 houses)`, 'log-income');
    beep(500);
    if (gameMode === 'online' && isMyTurn) {
      sendAction('sell-building', { tileIndex: tileIndex, playerIndex: current, amount: sellPrice, buildingType: 'villa' });
    }
    draw();
    updatePanels();
    updateButtons();
    return;
  }
  
  if (t.h > 0) {
    // Sell one house
    let sellPrice = Math.floor(t.buildCost * 0.5);
    t.h--;
    p.money += sellPrice;
    log(`üíµ ${p.name} sold 1 house on ${t.name} for $${sellPrice}`, 'log-income');
    beep(500);
    if (gameMode === 'online' && isMyTurn) {
      sendAction('sell-building', { tileIndex: tileIndex, playerIndex: current, amount: sellPrice, buildingType: 'house' });
    }
    draw();
    updatePanels();
    updateButtons();
    return;
  }
  
  // No buildings - sell the property itself
  let sellPrice = Math.floor(t.price * 0.5);
  t.o = -1;
  t.mortgaged = false; // Clear mortgage when selling
  p.money += sellPrice;
  log(`üíµ ${p.name} sold ${t.name} for $${sellPrice}`, 'log-income');
  beep(500);
  if (gameMode === 'online' && isMyTurn) {
    sendAction('sell', { tileIndex: tileIndex, playerIndex: current, amount: sellPrice });
  }
  sellingMode = false;
  draw();
  updatePanels();
  updateButtons();
}

function enterBuildMode(type) {
  if (sellingMode) sellingMode = false;
  buildMode = type;
  log(`üèóÔ∏è Build Mode (${type === 'house' ? 'House' : 'Hotel'}): Click a property to build`, 'log-action');
  draw();
  updateButtons();
}

function exitBuildMode() {
  buildMode = null;
  log('‚ùå Build Mode cancelled', 'log-action');
  draw();
  updateButtons();
}

function canBuildOn(tileIndex) {
  let t = tiles[tileIndex];
  if (t.type !== 'property') return false;
  if (t.o !== current) return false;
  if (t.mortgaged) return false; // Can't build on mortgaged property
  let sameRow = tiles.filter(tile => tile.type === 'property' && tile.row === t.row);
  let monopoly = sameRow.every(tile => tile.o === current);
  if (!monopoly) return false;
  
  if (buildMode === 'house') {
    if (t.h >= 4) return false;
    if (t.v > 0) return false;
    if (players[current].money < t.buildCost) return false;
    
    // Even building rule: You can only build if this property doesn't already have more houses than others
    let minHouses = Math.min(...sameRow.map(tile => tile.h + (tile.v * 5))); // Count hotels as 5
    let currentHouses = t.h + (t.v * 5);
    // Can only build if this property has the minimum number of houses (or tied for minimum)
    if (currentHouses > minHouses) return false;
    
    return true;
  }
  if (buildMode === 'villa') {
    if (t.h !== 4) return false; // Must have exactly 4 houses
    if (t.v > 0) return false;
    if (players[current].money < t.buildCost) return false;
    
    // Even building rule for hotels: All properties in monopoly must have 4 houses before any can get a hotel
    let allHaveFourHouses = sameRow.every(tile => tile.h === 4 || tile.v > 0);
    if (!allHaveFourHouses) return false;
    
    return true;
  }
  return false;
}

function buildOnProperty(tileIndex) {
  let t = tiles[tileIndex];
  let p = players[current];
  if (!canBuildOn(tileIndex)) return;
  if (buildMode === 'house') {
    t.h++;
    p.money -= t.buildCost;
    log(`üè† ${p.name} built a house on ${t.name} for $${t.buildCost}`, 'log-expense');
  } else if (buildMode === 'villa') {
    t.h = 0; // Clear all houses
    t.v++;
    p.money -= t.buildCost;
    log(`üè® ${p.name} built a hotel on ${t.name} for $${t.buildCost}`, 'log-expense');
  }
  beep(700);
  if (gameMode === 'online' && isMyTurn) {
    sendAction('build', { tileIndex: tileIndex, playerIndex: current, buildType: buildMode, cost: t.buildCost });
  }
  buildMode = null;
  draw();
  updatePanels();
  updateButtons();
  checkBankruptcy();
}

function enterMortgageMode() {
  if (sellingMode) sellingMode = false;
  if (buildMode) buildMode = null;
  if (unmortgageMode) unmortgageMode = false;
  mortgageMode = true;
  log('üè¶ Mortgage Mode: Click a property to mortgage for cash', 'log-action');
  draw();
  updateButtons();
}

function exitMortgageMode() {
  mortgageMode = false;
  log('‚ùå Mortgage Mode cancelled', 'log-action');
  draw();
  updateButtons();
}

function mortgageProperty(tileIndex) {
  let t = tiles[tileIndex];
  let p = players[current];
  if (t.o !== current) {
    log('‚ö†Ô∏è You don\'t own this property', 'log-action');
    return;
  }
  if (t.mortgaged) {
    log('‚ö†Ô∏è Property is already mortgaged', 'log-action');
    return;
  }
  if (t.h > 0 || t.v > 0) {
    log('‚ö†Ô∏è Must sell buildings first before mortgaging!', 'log-action');
    return;
  }
  let mortgageValue = Math.floor(t.price * 0.5);
  t.mortgaged = true;
  p.money += mortgageValue;
  log(`üè¶ ${p.name} mortgaged ${t.name} for $${mortgageValue}`, 'log-income');
  beep(500);
  if (gameMode === 'online' && isMyTurn) {
    sendAction('mortgage', { tileIndex: tileIndex, playerIndex: current, amount: mortgageValue });
  }
  mortgageMode = false;
  draw();
  updatePanels();
  updateButtons();
}

function enterUnmortgageMode() {
  if (sellingMode) sellingMode = false;
  if (buildMode) buildMode = null;
  if (mortgageMode) mortgageMode = false;
  unmortgageMode = true;
  log('üí≥ Unmortgage Mode: Click a mortgaged property to unmortgage (with 10% interest)', 'log-action');
  draw();
  updateButtons();
}

function exitUnmortgageMode() {
  unmortgageMode = false;
  log('‚ùå Unmortgage Mode cancelled', 'log-action');
  draw();
  updateButtons();
}

function unmortgageProperty(tileIndex) {
  let t = tiles[tileIndex];
  let p = players[current];
  if (t.o !== current) {
    log('‚ö†Ô∏è You don\'t own this property', 'log-action');
    return;
  }
  if (!t.mortgaged) {
    log('‚ö†Ô∏è Property is not mortgaged', 'log-action');
    return;
  }
  let mortgageValue = Math.floor(t.price * 0.5);
  let unmortgageCost = Math.floor(mortgageValue * (1 + INTEREST_RATE));
  if (p.money < unmortgageCost) {
    log(`‚ö†Ô∏è Not enough money! Need $${unmortgageCost} (includes ${(INTEREST_RATE * 100)}% interest)`, 'log-action');
    return;
  }
  t.mortgaged = false;
  p.money -= unmortgageCost;
  log(`üí≥ ${p.name} unmortgaged ${t.name} for $${unmortgageCost} (${(INTEREST_RATE * 100)}% interest)`, 'log-expense');
  beep(600);
  if (gameMode === 'online' && isMyTurn) {
    sendAction('unmortgage', { tileIndex: tileIndex, playerIndex: current, amount: unmortgageCost });
  }
  unmortgageMode = false;
  draw();
  updatePanels();
  updateButtons();
  checkBankruptcy();
}

function aiTakeTurn() {
  let p = players[current];
  let t = tiles[p.pos];
  if ((t.type === 'property' || t.type === 'railroad' || t.type === 'utility') && t.o === -1) {
    if (p.money >= t.price * 1.2) {
      setTimeout(() => {
        buyProperty();
        setTimeout(() => aiEndTurn(), 800);
      }, 800);
      return;
    } else {
      setTimeout(() => {
        startAuction(p.pos);
      }, 800);
      return;
    }
  }
  setTimeout(() => aiEndTurn(), 1200);
}

function aiEndTurn() {
  end();
}

function openTradeMenu() {
  if (players[current].isAI) {
    log('‚ö†Ô∏è AI players cannot initiate trades', 'log-action');
    return;
  }
  // Reset trade state
  selectedPartner = null;
  tradeGiveProperties = [];
  tradeReceiveProperties = [];
  document.getElementById('trade-give-money').value = '0';
  document.getElementById('trade-receive-money').value = '0';
  document.getElementById('trade-give-properties').innerHTML = '';
  document.getElementById('trade-receive-properties').innerHTML = '';
  
  document.getElementById('trade-modal').style.display = 'block';
  renderTradePartners();
}

function closeTradeMenu() {
  document.getElementById('trade-modal').style.display = 'none';
  selectedPartner = null;
  tradeGiveProperties = [];
  tradeReceiveProperties = [];
  document.getElementById('trade-give-money').value = '0';
  document.getElementById('trade-receive-money').value = '0';
  document.getElementById('trade-give-properties').innerHTML = '';
  document.getElementById('trade-receive-properties').innerHTML = '';
}

function renderTradePartners() {
  let list = document.getElementById('trade-partner-list');
  list.innerHTML = '';
  players.forEach((p, idx) => {
    if (idx === current) return;
    let btn = document.createElement('button');
    btn.textContent = p.name;
    btn.style.cssText = `padding:10px 20px;margin:5px;background:${p.color};color:white;border:none;border-radius:6px;cursor:pointer;font-weight:bold;`;
    if (selectedPartner === idx) {
      btn.style.border = '3px solid black';
    }
    btn.onclick = () => selectTradePartner(idx);
    list.appendChild(btn);
  });
}

function selectTradePartner(idx) {
  selectedPartner = idx;
  renderTradePartners();
  renderTradeProperties();
}

function renderTradeProperties() {
  if (selectedPartner === null) {
    // Show message to select a partner first
    document.getElementById('trade-give-properties').innerHTML = '<p style="color:#7f8c8d;text-align:center;padding:20px;">Select a trading partner above to view properties</p>';
    document.getElementById('trade-receive-properties').innerHTML = '<p style="color:#7f8c8d;text-align:center;padding:20px;">Select a trading partner above to view properties</p>';
    return;
  }
  let giveDiv = document.getElementById('trade-give-properties');
  giveDiv.innerHTML = '';
  tiles.forEach((t, i) => {
    if (t.o === current && (t.type === 'property' || t.type === 'railroad' || t.type === 'utility')) {
      let item = document.createElement('div');
      item.className = 'property-item';
      if (tradeGiveProperties.includes(i)) item.classList.add('selected');
      item.textContent = `#${i} - ${t.name}`;
      item.onclick = () => toggleGiveProperty(i);
      giveDiv.appendChild(item);
    }
  });
  if (giveDiv.innerHTML === '') {
    giveDiv.innerHTML = '<p style="color:#7f8c8d;text-align:center;padding:20px;">You have no properties to trade</p>';
  }
  let receiveDiv = document.getElementById('trade-receive-properties');
  receiveDiv.innerHTML = '';
  tiles.forEach((t, i) => {
    if (t.o === selectedPartner && (t.type === 'property' || t.type === 'railroad' || t.type === 'utility')) {
      let item = document.createElement('div');
      item.className = 'property-item';
      if (tradeReceiveProperties.includes(i)) item.classList.add('selected');
      item.textContent = `#${i} - ${t.name}`;
      item.onclick = () => toggleReceiveProperty(i);
      receiveDiv.appendChild(item);
    }
  });
  if (receiveDiv.innerHTML === '') {
    receiveDiv.innerHTML = '<p style="color:#7f8c8d;text-align:center;padding:20px;">Partner has no properties to trade</p>';
  }
}

function toggleGiveProperty(idx) {
  let i = tradeGiveProperties.indexOf(idx);
  if (i > -1) {
    tradeGiveProperties.splice(i, 1);
  } else {
    tradeGiveProperties.push(idx);
  }
  renderTradeProperties();
}

function toggleReceiveProperty(idx) {
  let i = tradeReceiveProperties.indexOf(idx);
  if (i > -1) {
    tradeReceiveProperties.splice(i, 1);
  } else {
    tradeReceiveProperties.push(idx);
  }
  renderTradeProperties();
}

function sendTrade() {
  if (selectedPartner === null) {
    alert('Select a trading partner first!');
    return;
  }
  let giveMoney = parseInt(document.getElementById('trade-give-money').value) || 0;
  let receiveMoney = parseInt(document.getElementById('trade-receive-money').value) || 0;
  if (tradeGiveProperties.length === 0 && tradeReceiveProperties.length === 0 && giveMoney === 0 && receiveMoney === 0) {
    alert('Add something to the trade!');
    return;
  }
  currentTrade = {
    from: current,
    to: selectedPartner,
    giveProperties: [...tradeGiveProperties],
    receiveProperties: [...tradeReceiveProperties],
    giveMoney: giveMoney,
    receiveMoney: receiveMoney
  };
  // Store partner info BEFORE closing menu (which resets selectedPartner to null)
  let partnerIsAI = players[selectedPartner].isAI;
  closeTradeMenu();
  if (partnerIsAI) {
    setTimeout(() => evaluateAITrade(), 1000);
  } else {
    showTradeOffer();
  }
}

function showTradeOffer() {
  let trade = currentTrade;
  document.getElementById('trade-offer-from').textContent = `Trade offer from ${players[trade.from].name}:`;
  let theyGive = document.getElementById('trade-offer-they-give');
  theyGive.innerHTML = '';
  if (trade.giveMoney > 0) {
    let money = document.createElement('div');
    money.textContent = `üíµ $${trade.giveMoney}`;
    theyGive.appendChild(money);
  }
  trade.giveProperties.forEach(i => {
    let prop = document.createElement('div');
    prop.textContent = `üè† ${tiles[i].name}`;
    theyGive.appendChild(prop);
  });
  if (trade.giveMoney === 0 && trade.giveProperties.length === 0) {
    theyGive.textContent = 'Nothing';
  }
  let youGive = document.getElementById('trade-offer-you-give');
  youGive.innerHTML = '';
  if (trade.receiveMoney > 0) {
    let money = document.createElement('div');
    money.textContent = `üíµ $${trade.receiveMoney}`;
    youGive.appendChild(money);
  }
  trade.receiveProperties.forEach(i => {
    let prop = document.createElement('div');
    prop.textContent = `üè† ${tiles[i].name}`;
    youGive.appendChild(prop);
  });
  if (trade.receiveMoney === 0 && trade.receiveProperties.length === 0) {
    youGive.textContent = 'Nothing';
  }
  document.getElementById('trade-offer-modal').style.display = 'block';
}

function acceptTrade() {
  let trade = currentTrade;
  players[trade.from].money -= trade.giveMoney;
  players[trade.to].money += trade.giveMoney;
  players[trade.to].money -= trade.receiveMoney;
  players[trade.from].money += trade.receiveMoney;
  trade.giveProperties.forEach(i => {
    tiles[i].o = trade.to;
  });
  trade.receiveProperties.forEach(i => {
    tiles[i].o = trade.from;
  });
  log(`ü§ù Trade accepted between ${players[trade.from].name} and ${players[trade.to].name}!`, 'log-income');
  beep(700);
  document.getElementById('trade-offer-modal').style.display = 'none';
  currentTrade = null;
  draw();
  updatePanels();
}

function rejectTrade() {
  log(`‚ùå Trade rejected by ${players[currentTrade.to].name}`, 'log-action');
  document.getElementById('trade-offer-modal').style.display = 'none';
  currentTrade = null;
}

function evaluateAITrade() {
  let trade = currentTrade;
  // From AI's perspective:
  // - trade.giveMoney/giveProperties = what the HUMAN gives (AI RECEIVES)
  // - trade.receiveMoney/receiveProperties = what the HUMAN receives (AI GIVES)
  
  // Calculate what AI is RECEIVING (from human)
  let aiReceivesValue = trade.giveMoney;
  trade.giveProperties.forEach(i => {
    aiReceivesValue += tiles[i].price;
  });
  
  // Calculate what AI is GIVING (to human)
  let aiGivesValue = trade.receiveMoney;
  trade.receiveProperties.forEach(i => {
    aiGivesValue += tiles[i].price;
  });
  
  // AI accepts if what it receives is worth at least 90% of what it gives
  // (i.e., AI won't accept deals where it loses more than 10% value)
  if (aiReceivesValue >= aiGivesValue * 0.9) {
    acceptTrade();
  } else {
    rejectTrade();
  }
}

function startAuction(tileIndex) {
  let t = tiles[tileIndex];
  auction = {
    tileIndex: tileIndex,
    tilePrice: t.price,
    currentBid: Math.floor(t.price / 2), // E. Start at half price
    highBidder: null,
    participants: [],
    activeSeat: 0,
    auctionLog: []
    // D. Removed timerInterval
  };
  players.forEach((p, idx) => {
    auction.participants.push({
      playerIndex: idx,
      passed: false,
      isAI: p.isAI
    });
  });
  auction.activeSeat = (current + 1) % players.length;
  document.getElementById('auction-modal').style.display = 'block';
  renderAuction();
  advanceAuctionIfAI();
}

function renderAuction() {
  if (!auction) return;
  let t = tiles[auction.tileIndex];
  document.getElementById('auction-tile-name').textContent = t.name;
  document.getElementById('auction-market-price').textContent = `Market Price: $${auction.tilePrice}`;
  let bidDiv = document.getElementById('auction-current-bid');
  bidDiv.textContent = `Current Bid: $${auction.currentBid}`;
  if (auction.highBidder !== null) {
    let bidder = auction.participants[auction.highBidder];
    bidDiv.textContent += ` by ${players[bidder.playerIndex].name}`;
  }
  // D. Removed resetAuctionTimer()
  let grid = document.getElementById('auction-players-grid');
  grid.innerHTML = '';
  auction.participants.forEach((part, seat) => {
    let p = players[part.playerIndex];
    let isActive = seat === auction.activeSeat && !part.passed;
    let isBidder = seat === auction.highBidder;
    let isOut = part.passed;
    let row = document.createElement('div');
    row.className = 'auction-player-row' + (isActive ? ' current-bidder' : '') + (isOut ? ' passed' : '') + (part.isAI ? ' ai-row' : '');
    let nextBid = auction.currentBid + 20; // E. Change to $20 increment
    let canAfford = p.money >= nextBid;
    let statusHtml = '';
    if (isOut) {
      statusHtml = '<span class="auction-player-status out">‚õî Passed</span>';
    } else if (isBidder) {
      statusHtml = '<span class="auction-player-status">üèÜ Winning</span>';
    } else if (isActive) {
      statusHtml = '<span class="auction-player-status" style="color:#e74c3c;">‚è≥ Your turn</span>';
    }
    let buttonsHtml = '';
    if (!isOut && isActive && !part.isAI) {
      buttonsHtml = `<button class="auction-bid-btn btn-bid" onclick="auctionBid()" ${!canAfford ? 'disabled' : ''}>Bid $${nextBid}</button><button class="auction-bid-btn btn-pass" onclick="auctionPass()">Pass</button>`;
    }
    row.innerHTML = `<div><div class="auction-player-name" style="color:${p.color}">${p.name}${part.isAI ? ' ü§ñ' : ''}</div><div class="auction-player-cash">Cash: $${p.money}</div></div>${statusHtml}<div style="display:flex;gap:6px;">${buttonsHtml}</div>`;
    grid.appendChild(row);
  });
  let logDiv = document.getElementById('auction-log');
  logDiv.innerHTML = auction.auctionLog.slice(-8).join('<br>');
  logDiv.scrollTop = logDiv.scrollHeight;
}

function auctionLog(msg) {
  auction.auctionLog.push(msg);
}

// D. Removed resetAuctionTimer function

function calcNextBid() {
  return auction.currentBid + 20; // E. Change to $20 increment
}

function auctionBid() {
  if (!auction) return;
  let seat = auction.activeSeat;
  let part = auction.participants[seat];
  let p = players[part.playerIndex];
  let nextBid = calcNextBid();
  if (p.money < nextBid) {
    auctionLog(`‚ùå ${p.name} can't afford $${nextBid}!`);
    renderAuction();
    return;
  }
  auction.currentBid = nextBid;
  auction.highBidder = seat;
  auctionLog(`üí∞ ${p.name} bids $${nextBid}`);
  beep(600);
  advanceAuctionSeat();
}

function auctionPass() {
  if (!auction) return;
  let seat = auction.activeSeat;
  let part = auction.participants[seat];
  auctionLog(`üôÖ ${players[part.playerIndex].name} passes`);
  auction.participants[seat].passed = true;
  beep(300);
  advanceAuctionSeat();
}

function advanceAuctionSeat() {
  if (auction.timerInterval) clearInterval(auction.timerInterval);
  let active = auction.participants.filter(p => !p.passed);
  if (active.length === 1) {
    finishAuction(active[0]);
    return;
  }
  if (active.length === 0) {
    finishAuction(null);
    return;
  }
  let next = (auction.activeSeat + 1) % auction.participants.length;
  let loops = 0;
  while (auction.participants[next].passed) {
    next = (next + 1) % auction.participants.length;
    loops++;
    if (loops > auction.participants.length) {
      finishAuction(null);
      return;
    }
  }
  auction.activeSeat = next;
  renderAuction();
  advanceAuctionIfAI();
}

function advanceAuctionIfAI() {
  if (!auction) return;
  let part = auction.participants[auction.activeSeat];
  if (!part || part.passed || !part.isAI) return;
  setTimeout(() => {
    if (!auction) return;
    let p = players[part.playerIndex];
    let nextBid = calcNextBid();
    let bidThreshold = auction.tilePrice * 0.75;
    let shouldBid = nextBid <= bidThreshold && p.money >= nextBid * 2 && secureRandom() > 0.25;
    if (shouldBid) {
      auctionBid();
    } else {
      auctionPass();
    }
  }, 700 + Math.floor(secureRandom() * 500));
}

function finishAuction(winner) {
  if (auction.timerInterval) clearInterval(auction.timerInterval);
  if (!winner || auction.highBidder === null) {
    auctionLog('üèöÔ∏è No bids ‚Äî property remains unowned.');
    log(`üèöÔ∏è Auction for Tile ${auction.tileIndex} ended with no winner. Property stays unowned.`, 'log-action');
    beep(200);
    closeAuction();
    return;
  }
  let pIdx = winner.playerIndex;
  let finalPrice = auction.currentBid;
  players[pIdx].money -= finalPrice;
  tiles[auction.tileIndex].o = pIdx;
  auctionLog(`üéâ ${players[pIdx].name} won Tile ${auction.tileIndex} for $${finalPrice}!`);
  log(`üî® ${players[pIdx].name} won auction for Tile ${auction.tileIndex} at $${finalPrice}! (Market: $${auction.tilePrice})`, 'log-income');
  beep(700);
  beep(900);
  renderAuction();
  setTimeout(() => {
    closeAuction();
    checkBankruptcy();
  }, 1200);
}

function closeAuction() {
  if (auction && auction.timerInterval) clearInterval(auction.timerInterval);
  auction = null;
  document.getElementById('auction-modal').style.display = 'none';
  draw();
  updatePanels();
  updateButtons();
  _endTurnAfterAuction();
}

function _endTurnAfterAuction() {
  let inJail = players[current].jailTurns > 0;
  if (sellingMode) toggleSellMode();
  if (buildMode) exitBuildMode();
  if (mortgageMode) exitMortgageMode();
  if (unmortgageMode) exitUnmortgageMode();
  if (!inJail) {
    log(`‚úÖ ${players[current].name} ended turn`, 'log-action');
  }
  rolled = false;
  if (gameMode === 'online' && isMyTurn) {
    sendAction('end');
  }
  switchTurn();
}

document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT') return;
  if (!gameMode) return;
  if (gameMode === 'online' && !isMyTurn) return;
  let key = e.key.toLowerCase();
  switch(key) {
    case ' ':
      e.preventDefault();
      let rollBtn = document.getElementById('rollBtn');
      if (rollBtn && !rollBtn.disabled) {
        roll();
      }
      break;
    case 'enter':
      e.preventDefault();
      let endBtn = document.getElementById('endBtn');
      if (endBtn && !endBtn.disabled) {
        end();
      }
      break;
    case 'b':
      e.preventDefault();
      let buyBtn = document.getElementById('buyBtn');
      let bailBtn = document.getElementById('bailBtn');
      if (buyBtn && !buyBtn.disabled) {
        buy();
      } else if (bailBtn && !bailBtn.disabled) {
        payBail();
      }
      break;
    case 's':
      e.preventDefault();
      let sellBtn = document.getElementById('sellBtn');
      if (sellBtn && !sellBtn.disabled) {
        toggleSellMode();
      }
      break;
    case 't':
      e.preventDefault();
      let tradeBtn = document.getElementById('tradeBtn');
      if (tradeBtn && !tradeBtn.disabled) {
        openTradeMenu();
      }
      break;
    case 'h':
      e.preventDefault();
      let houseBtn = document.getElementById('buildBtn');
      if (houseBtn && !houseBtn.disabled) {
        enterBuildMode('house');
      }
      break;
    case 'v':
      e.preventDefault();
      let villaBtn = document.getElementById('buildBtn');
      if (villaBtn && !villaBtn.disabled) {
        enterBuildMode('villa');
      }
      break;
    case 'm':
      e.preventDefault();
      let mortgageBtn = document.getElementById('mortgageBtn');
      if (mortgageBtn && !mortgageBtn.disabled) {
        enterMortgageMode();
      }
      break;
    case 'u':
      e.preventDefault();
      let unmortgageBtn = document.getElementById('unmortgageBtn');
      if (unmortgageBtn && !unmortgageBtn.disabled) {
        enterUnmortgageMode();
      }
      break;
    case 'escape':
      e.preventDefault();
      if (buildMode) {
        exitBuildMode();
      } else if (sellingMode) {
        toggleSellMode();
      } else if (mortgageMode) {
        exitMortgageMode();
      } else if (unmortgageMode) {
        exitUnmortgageMode();
      }
      break;
  }
});

function updatePanels() {
  let panel = document.getElementById('panel');
  panel.innerHTML = '<h3>üë• Players</h3>';
  players.forEach((p, idx) => {
    let card = document.createElement('div');
    card.className = 'player-card';
    card.style.borderColor = p.color;
    if (idx === current) card.classList.add('active');

    // Color dot
    let dot = document.createElement('div');
    dot.style.cssText = `width:10px;height:10px;border-radius:50%;background:${p.color};flex-shrink:0;border:1.5px solid #333;`;
    card.appendChild(dot);

    let name = document.createElement('span');
    name.className = 'pc-name';
    name.textContent = p.name;
    card.appendChild(name);

    let money = document.createElement('span');
    money.className = 'pc-money';
    money.textContent = `$${p.money}`;
    card.appendChild(money);

    let properties = tiles.filter(t => t.o === idx && (t.type === 'property' || t.type === 'railroad' || t.type === 'utility'));
    let propCount = document.createElement('span');
    propCount.className = 'pc-props';
    propCount.textContent = `üè†${properties.length}`;
    card.appendChild(propCount);

    if (p.jailTurns > 0) {
      let jail = document.createElement('span');
      jail.className = 'pc-jail';
      jail.textContent = `üîí${p.jailTurns}`;
      card.appendChild(jail);
    }
    if (p.jailFreeCards && p.jailFreeCards.length > 0) {
      let jfc = document.createElement('span');
      jfc.style.cssText = 'font-size:11px;color:#f0932b;font-weight:bold;';
      jfc.textContent = `üÉè√ó${p.jailFreeCards.length}`;
      card.appendChild(jfc);
    }
    panel.appendChild(card);
  });
  let status = document.getElementById('status');
  if (gameMode === 'online') {
    status.textContent = isMyTurn ? `Your turn (${players[current].name})` : `${players[current].name}'s turn`;
  } else {
    status.textContent = `${players[current].name}'s Turn`;
  }
}

function updateButtons() {
  let p = players[current];
  let t = tiles[p.pos];
  let canPlay = (gameMode !== 'online' || isMyTurn);
  document.getElementById('rollBtn').disabled = rolled || !canPlay;
  let canBuy = rolled && (t.type === 'property' || t.type === 'railroad' || t.type === 'utility') && t.o === -1 && p.money >= t.price && canPlay;
  document.getElementById('buyBtn').disabled = !canBuy;
  document.getElementById('endBtn').disabled = !rolled && p.jailTurns === 0 || !canPlay;
  document.getElementById('sellBtn').disabled = !canPlay;
  document.getElementById('buildBtn').disabled = !canPlay;
  document.getElementById('villaBtn').disabled = !canPlay;
  document.getElementById('tradeBtn').disabled = !canPlay;
  document.getElementById('mortgageBtn').disabled = !canPlay;
  document.getElementById('unmortgageBtn').disabled = !canPlay;
  let bailBtn = document.getElementById('bailBtn');
  let gojfBtn = document.getElementById('gojfBtn');
  if (p.jailTurns > 0 && canPlay) {
    bailBtn.style.display = 'inline-block';
    bailBtn.disabled = p.money < 50;
    gojfBtn.style.display = (p.jailFreeCards && p.jailFreeCards.length > 0) ? 'inline-block' : 'none';
  } else {
    bailBtn.style.display = 'none';
    gojfBtn.style.display = 'none';
  }
}

function checkBankruptcy() {
  players.forEach((p, idx) => {
    if (p.money < 0) {
      log(`üíÄ ${p.name} is BANKRUPT!`, 'log-expense');
      beep(200);
      beep(200);
      beep(200);
      tiles.forEach(t => {
        if (t.o === idx) {
          t.o = -1;
          t.h = 0;
          t.v = 0;
          t.mortgaged = false;
        }
      });
      let activePlayers = players.filter(p => p.money >= 0);
      if (activePlayers.length === 1) {
        setTimeout(() => {
          alert(`üèÜ ${activePlayers[0].name} WINS!`);
          backToMenu();
        }, 1000);
      }
    }
  });
}

function log(message, type = '') {
  logEntries.push({ msg: message, type: type });
  let logDiv = document.getElementById('log');
  let entry = document.createElement('div');
  entry.className = 'log-entry ' + type;
  entry.textContent = message;
  logDiv.appendChild(entry);
  logDiv.scrollTop = logDiv.scrollHeight;
}

function beep(freq) {
  if (typeof AudioContext !== 'undefined') {
    try {
      let ctx = new AudioContext();
      let osc = ctx.createOscillator();
      let gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = freq;
      gain.gain.value = 0.1;
      osc.start();
      setTimeout(() => osc.stop(), 100);
    } catch (e) {}
  }
}

// C. Display tile information when clicked
function displayTileInfo(tileIndex) {
  let t = tiles[tileIndex];
  let contentDiv = document.getElementById('tile-info-content');
  let html = `<div class="tile-info"><strong>Tile #${tileIndex}: ${t.name}</strong><br>`;

  if (t.type === 'property') {
    const colorNames = ['Brown','Light Blue','Pink','Orange','Red','Yellow','Green','Dark Blue'];
    html += `<em>${colorNames[t.row] || 'Property'} group &bull; Price: $${t.price} &bull; Build: $${t.buildCost}/house</em><br>`;
    if (t.o >= 0) html += `Owner: <strong style="color:${players[t.o].color}">${players[t.o].name}</strong>`;
    else html += `Status: <em>Unowned</em>`;
    if (t.mortgaged) html += ` &nbsp;<span style="color:#e74c3c;font-weight:bold;">[MORTGAGED]</span>`;
    html += `<br>`;
    if (t.h > 0) html += `Buildings: ${t.h} house${t.h > 1 ? 's' : ''}<br>`;
    if (t.v > 0) html += `Buildings: üè® Hotel<br>`;

    // Full rent breakdown table
    const activeLevel = t.v > 0 ? 5 : t.h > 0 ? t.h : 0;
    const labels = ['Base rent','1 House','2 Houses','3 Houses','4 Houses','Hotel'];
    html += `<table style="width:100%;border-collapse:collapse;margin-top:6px;font-size:11px;">`;
    html += `<tr style="background:#f0f0f0;"><th style="text-align:left;padding:2px 4px;">Level</th><th style="text-align:right;padding:2px 4px;">Rent</th><th style="text-align:left;padding:2px 8px;font-size:10px;color:#888;">Note</th></tr>`;
    labels.forEach((label, idx) => {
      const isActive = idx === activeLevel;
      const monopoly = tiles.filter(tile => tile.type === 'property' && tile.row === t.row).every(tile => tile.o === t.o);
      let rentVal = t.rent[idx];
      let note = '';
      if (idx === 0 && monopoly && t.h === 0 && t.v === 0) { rentVal = t.rent[0] * 2; note = '(monopoly √ó2)'; }
      const bg = isActive ? 'background:#fff3cd;font-weight:bold;' : '';
      html += `<tr style="${bg}">
        <td style="padding:2px 4px;">${isActive ? '‚ñ∂ ' : ''}${label}</td>
        <td style="text-align:right;padding:2px 4px;color:#c0392b;">$${rentVal}</td>
        <td style="padding:2px 8px;font-size:10px;color:#888;">${note}</td>
      </tr>`;
    });
    html += `</table>`;
    const mortgageVal = Math.floor(t.price * 0.5);
    const unmortgageCost = Math.floor(mortgageVal * 1.1);
    html += `<div style="margin-top:4px;font-size:10px;color:#666;">Mortgage: $${mortgageVal} &bull; Unmortgage: $${unmortgageCost}</div>`;

  } else if (t.type === 'railroad') {
    html += `<em>Railroad &bull; Price: $${t.price}</em><br>`;
    if (t.o >= 0) html += `Owner: <strong style="color:${players[t.o].color}">${players[t.o].name}</strong>`;
    else html += `Status: <em>Unowned</em>`;
    if (t.mortgaged) html += ` &nbsp;<span style="color:#e74c3c;font-weight:bold;">[MORTGAGED]</span>`;
    html += `<br>`;
    const railCount = t.o >= 0 ? tiles.filter(tile => tile.type === 'railroad' && tile.o === t.o).length : 0;
    const railRents = [25, 50, 100, 200];
    html += `<table style="width:100%;border-collapse:collapse;margin-top:6px;font-size:11px;">`;
    html += `<tr style="background:#f0f0f0;"><th style="text-align:left;padding:2px 4px;">Railroads owned</th><th style="text-align:right;padding:2px 4px;">Rent</th></tr>`;
    [1,2,3,4].forEach(n => {
      const isActive = t.o >= 0 && n === railCount;
      const bg = isActive ? 'background:#fff3cd;font-weight:bold;' : '';
      html += `<tr style="${bg}">
        <td style="padding:2px 4px;">${isActive ? '‚ñ∂ ' : ''}${n} railroad${n > 1 ? 's' : ''}</td>
        <td style="text-align:right;padding:2px 4px;color:#c0392b;">$${railRents[n-1]}</td>
      </tr>`;
    });
    html += `</table>`;
    const mortgageVal = Math.floor(t.price * 0.5);
    html += `<div style="margin-top:4px;font-size:10px;color:#666;">Mortgage: $${mortgageVal} &bull; Unmortgage: $${Math.floor(mortgageVal*1.1)}</div>`;

  } else if (t.type === 'utility') {
    html += `<em>Utility &bull; Price: $${t.price}</em><br>`;
    if (t.o >= 0) html += `Owner: <strong style="color:${players[t.o].color}">${players[t.o].name}</strong>`;
    else html += `Status: <em>Unowned</em>`;
    if (t.mortgaged) html += ` &nbsp;<span style="color:#e74c3c;font-weight:bold;">[MORTGAGED]</span>`;
    html += `<br>`;
    const utilCount = t.o >= 0 ? tiles.filter(tile => tile.type === 'utility' && tile.o === t.o).length : 0;
    html += `<table style="width:100%;border-collapse:collapse;margin-top:6px;font-size:11px;">`;
    html += `<tr style="background:#f0f0f0;"><th style="text-align:left;padding:2px 4px;">Utilities owned</th><th style="text-align:right;padding:2px 4px;">Rent</th></tr>`;
    [[1,'4√ó dice roll'],[2,'10√ó dice roll']].forEach(([n, label]) => {
      const isActive = t.o >= 0 && n === utilCount;
      const bg = isActive ? 'background:#fff3cd;font-weight:bold;' : '';
      html += `<tr style="${bg}">
        <td style="padding:2px 4px;">${isActive ? '‚ñ∂ ' : ''}${n} utilit${n === 1 ? 'y' : 'ies'}</td>
        <td style="text-align:right;padding:2px 4px;color:#c0392b;">${label}</td>
      </tr>`;
    });
    html += `</table>`;
    const mortgageVal = Math.floor(t.price * 0.5);
    html += `<div style="margin-top:4px;font-size:10px;color:#666;">Mortgage: $${mortgageVal} &bull; Unmortgage: $${Math.floor(mortgageVal*1.1)}</div>`;

  } else if (t.type === 'tax') {
    html += `Type: Tax &bull; Amount: <strong>$${t.amount}</strong>`;
  } else if (t.type === 'go') {
    html += `Collect <strong>$200</strong> when passing or landing.`;
  } else if (t.type === 'jail') {
    html += `Just Visiting ‚Äî no effect unless sent here by Go to Jail.`;
  } else if (t.type === 'gotojail') {
    html += `<strong>Go to Jail!</strong> Move directly to Jail, do not pass GO.`;
  } else if (t.type === 'freeparking') {
    html += `Free Parking ‚Äî no effect.`;
  } else if (t.type === 'luck') {
    const chanceTiles = [7, 22, 36];
    html += chanceTiles.includes(tileIndex) ? `üé≤ <strong>Chance</strong> ‚Äî Draw a Chance card.` : `üì¶ <strong>Community Chest</strong> ‚Äî Draw a Community Chest card.`;
  } else {
    html += `Type: ${t.type}`;
  }

  html += `</div>`;
  contentDiv.innerHTML = html;
}

// B. Save game to localStorage
function saveGame() {
  console.log('=== SAVE GAME FUNCTION CALLED ===');
  try {
    // Validate game state before saving
    if (!tiles || tiles.length === 0) {
      alert('‚ùå No game data to save!\n\nPlease start a game first.');
      console.error('Save failed: no tiles');
      return;
    }
    if (!players || players.length === 0) {
      alert('‚ùå No players to save!\n\nPlease start a game first.');
      console.error('Save failed: no players');
      return;
    }
    
    console.log('Creating game state object...');
    let gameState = {
      tiles: tiles,
      players: players,
      current: current,
      rolled: rolled,
      diceRoll: diceRoll,
      gameMode: gameMode,
      numPlayers: numPlayers,
      logEntries: logEntries
    };
    
    let jsonData = JSON.stringify(gameState);
    console.log(`Saving ${jsonData.length} characters to localStorage...`);
    
    localStorage.setItem('monopoly_save', jsonData);
    console.log('Save successful!');
    
    alert(`‚úÖ Game saved successfully!\n\nSaved ${jsonData.length} characters\n${players.length} players\nCurrent turn: ${players[current].name}`);
    log('üíæ Game saved', 'log-action');
    console.log('=== SAVE COMPLETE ===');
  } catch (e) {
    console.error('Save error:', e);
    alert('‚ùå Failed to save game: ' + e.message + '\n\nCheck browser console for details.');
  }
}

// B. Load game from localStorage
function loadGame() {
  // Immediate visual feedback
  console.log('=== LOAD GAME FUNCTION CALLED ===');
  
  try {
    console.log('Attempting to get saved game...');
    let saved = localStorage.getItem('monopoly_save');
    console.log('Saved data:', saved ? `Found (${saved.length} chars)` : 'Not found');
    
    if (!saved) {
      alert('‚ùå No saved game found!\n\nTo save a game:\n1. Start a new game\n2. Play for a bit\n3. Click "üíæ Save Game" button');
      console.log('No saved game in localStorage');
      return;
    }
    
    // Load immediately without confirmation
    console.log('Parsing saved data...');
    let gameState = JSON.parse(saved);
    console.log('Game state parsed:', gameState);
    
    // Validate loaded data
    if (!gameState.tiles || !gameState.players) {
      alert('‚ùå Saved game data is corrupted!');
      console.error('Corrupted data - missing tiles or players');
      return;
    }
    
    console.log('Restoring game state...');
    tiles = gameState.tiles;
    players = gameState.players;
    current = gameState.current || 0;
    rolled = gameState.rolled || false;
    diceRoll = gameState.diceRoll || [0, 0];
    gameMode = gameState.gameMode || 'local';
    numPlayers = gameState.numPlayers || players.length;
    logEntries = gameState.logEntries || [];
    
    // Clear modes
    sellingMode = false;
    buildMode = null;
    mortgageMode = false;
    unmortgageMode = false;
    
    console.log('Showing game screen...');
    // Show game screen and hide menu screens
    document.getElementById('menu-screen').style.display = 'none';
    document.getElementById('player-count-screen').style.display = 'none';
    document.getElementById('online-lobby').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    
    console.log('Restoring log...');
    // Restore log
    let logDiv = document.getElementById('log');
    if (logDiv) {
      logDiv.innerHTML = '';
      logEntries.forEach(entry => {
        let div = document.createElement('div');
        div.className = 'log-entry ' + (entry.type || '');
        div.textContent = entry.msg;
        logDiv.appendChild(div);
      });
    }
    
    console.log('Drawing board...');
    draw();
    updatePanels();
    updateButtons();
    alert('‚úÖ Game loaded successfully!');
    log('üìÇ Game loaded', 'log-action');
    console.log('=== LOAD COMPLETE ===');
  } catch (e) {
    console.error('Load error:', e);
    alert('‚ùå Failed to load game: ' + e.message + '\n\nCheck browser console for details.');
  }
}

// B. End game and declare winner based on wealth
function endGame() {
  if (!confirm('üèÜ End the game and declare a winner?')) {
    return;
  }
  
  // Calculate total wealth for each player
  let rankings = players.map((p, idx) => {
    let wealth = p.money;
    tiles.forEach(t => {
      if (t.o === idx) {
        wealth += Math.floor(t.price * (t.mortgaged ? 0 : 0.5)); // Property value
        if (t.type === 'property' && t.buildCost) {
          wealth += (t.h * Math.floor(t.buildCost * 0.5)); // House value
          wealth += (t.v * Math.floor(t.buildCost * 0.5)); // Hotel value
        }
      }
    });
    return { name: p.name, color: p.color, wealth: wealth, money: p.money };
  }).sort((a, b) => b.wealth - a.wealth);
  
  let message = 'üèÜ FINAL RANKINGS üèÜ\n\n';
  rankings.forEach((r, idx) => {
    message += `${idx + 1}. ${r.name}: $${r.wealth} (Cash: $${r.money})\n`;
  });
  message += `\nüëë WINNER: ${rankings[0].name}! üëë`;
  
  alert(message);
  log(`üèÜ Game ended! Winner: ${rankings[0].name} with $${rankings[0].wealth}`, 'log-action');
}
</script>
</body>
</html>
