<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Monopoly Classic - 8√ó5 Board</title>
<script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
<style>
* { box-sizing: border-box; }
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  text-align: center;
  margin: 0;
  padding: 20px;
  min-height: 100vh;
}
h2 { color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); margin-bottom: 10px; }
#status { color: white; font-size: 18px; font-weight: bold; margin-bottom: 15px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }

#menu-screen { max-width: 600px; margin: 50px auto; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
#menu-screen h3 { color: #2c3e50; margin-bottom: 30px; font-size: 24px; }

.menu-button {
  display: block; width: 100%; padding: 20px; margin: 15px 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold;
  cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.menu-button:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
.menu-button:active { transform: translateY(0); }
.menu-button.ai { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.menu-button.online { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.menu-button.local { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
.menu-button .subtitle { font-size: 14px; opacity: 0.9; margin-top: 5px; font-weight: normal; }

#player-count-screen { display: none; max-width: 500px; margin: 50px auto; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
#player-count-screen h3 { color: #2c3e50; margin-bottom: 30px; }
.player-count-btn {
  display: inline-block; width: 80px; padding: 20px; margin: 10px;
  background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
  color: white; border: none; border-radius: 12px; font-size: 24px; font-weight: bold;
  cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.player-count-btn:hover { transform: translateY(-3px); }

#online-lobby { display: none; max-width: 500px; margin: 50px auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
#online-lobby h3 { color: #2c3e50; margin-bottom: 20px; }
.lobby-section { margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; }
.lobby-input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; text-align: center; text-transform: uppercase; letter-spacing: 2px; }
.room-code-display { font-size: 32px; font-weight: bold; color: #667eea; letter-spacing: 4px; padding: 15px; background: white; border-radius: 8px; margin: 15px 0; }

.connection-status { padding: 10px; border-radius: 6px; margin: 10px 0; font-weight: bold; }
.status-waiting { background: #fff3cd; color: #856404; }
.status-connected { background: #d4edda; color: #155724; }
.status-error { background: #f8d7da; color: #721c24; }

#game-screen { display: none; }
#wrap { display: flex; justify-content: center; align-items: flex-start; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
#left-panel { display: flex; flex-direction: column; gap: 15px; }

@media (max-width: 768px) {
  #board { width: 90vw !important; height: 90vw !important; max-width: 540px; max-height: 540px; }
  .controls { width: 90% !important; max-width: 540px; }
  .controls button { font-size: 12px !important; padding: 8px 12px !important; }
}

#board {
  display: grid; gap: 6px; background: #2c3e50; padding: 10px;
  border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.3);
}

.tile {
  border: 2px solid #34495e; background: white; font-size: 10px;
  position: relative; padding: 6px 4px; border-radius: 6px;
  transition: transform 0.2s, box-shadow 0.2s; overflow: hidden;
}
.tile:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
.tile-header { font-weight: bold; margin-bottom: 3px; padding: 2px; border-radius: 3px; font-size: 11px; }

.row-0 { background: #8d6e63; color: white; }
.row-1 { background: #81d4fa; color: #333; }
.row-2 { background: #f48fb1; color: white; }
.row-3 { background: #ffb74d; color: #333; }
.row-4 { background: #ef5350; color: white; }
.row-5 { background: #ba68c8; color: white; }
.row-6 { background: #ffa726; color: white; }
.row-7 { background: #42a5f5; color: white; }

.luck-tile { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%) !important; }
.jail-tile { background: linear-gradient(135deg, #607d8b 0%, #90a4ae 100%) !important; }
.rail-tile { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%) !important; color: white !important; }
.rail-tile .tile-header { background: #e94560 !important; color: white !important; }

.utility-tile { background: linear-gradient(135deg, #26c6da 0%, #00acc1 100%) !important; color: white !important; }
.utility-tile .tile-header { background: #00838f !important; color: white !important; }

.go-tile { background: linear-gradient(135deg, #e8f5e9 0%, #a5d6a7 100%) !important; }
.gotojail-tile { background: linear-gradient(135deg, #ffebee 0%, #ef9a9a 100%) !important; }
.freeparking-tile { background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%) !important; }
.tax-tile { background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%) !important; }

.tile.sellable { cursor: pointer; box-shadow: 0 0 10px rgba(76, 175, 80, 0.8) !important; border: 3px solid #4CAF50 !important; }
.tile.sellable:hover { transform: translateY(-4px) !important; box-shadow: 0 6px 12px rgba(76, 175, 80, 0.9) !important; }
.tile.buildable { cursor: pointer; box-shadow: 0 0 10px rgba(255, 152, 0, 0.8) !important; border: 3px solid #FF9800 !important; }
.tile.buildable:hover { transform: translateY(-4px) !important; box-shadow: 0 6px 12px rgba(255, 152, 0, 0.9) !important; }

.pawn {
  display: inline-block; width: 16px; height: 16px; border-radius: 50%;
  margin: 2px; border: 2px solid #333; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  animation: pawnAppear 0.3s ease;
}
@keyframes pawnAppear { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.house {
  width: 14px; height: 14px; background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);
  display: inline-block; margin: 1px; border-radius: 3px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.3); animation: buildingAppear 0.3s ease;
}
.villa {
  width: 20px; height: 16px; background: linear-gradient(135deg, #e53935 0%, #ef5350 100%);
  display: inline-block; margin: 1px; border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.4); animation: buildingAppear 0.3s ease;
}
@keyframes buildingAppear { from { transform: scale(0) rotate(0deg); } to { transform: scale(1) rotate(360deg); } }

.controls {
  background: white; padding: 20px; border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2); width: 540px; max-width: 90%;
}
.controls button {
  padding: 12px 20px; margin: 5px; font-size: 14px; font-weight: bold;
  border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.controls button:not(:disabled):hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
.controls button:not(:disabled):active { transform: translateY(0); }
.controls button:disabled { opacity: 0.4; cursor: not-allowed; }

#rollBtn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
#buyBtn { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
#endBtn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
#sellBtn { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; }
#buildBtn { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; }
#bailBtn { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #333; }
#tradeBtn { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; }

#panel {
  background: white; padding: 15px; border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2); text-align: left;
  max-width: 300px; width: 100%;
}

.player-card {
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  padding: 12px; margin: 8px 0; border-radius: 8px;
  border-left: 4px solid; transition: transform 0.2s;
}
.player-card.active { transform: translateX(5px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

#log {
  background: white; padding: 15px; border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2); text-align: left;
  max-width: 400px; width: 100%; height: 300px; overflow-y: auto; font-size: 13px;
}

.log-entry { padding: 6px; margin: 3px 0; border-radius: 4px; }
.log-expense { background: #ffebee; color: #c62828; }
.log-income { background: #e8f5e9; color: #2e7d32; }
.log-action { background: #e3f2fd; color: #1565c0; }

.modal {
  display: none; position: fixed; z-index: 1000; left: 0; top: 0;
  width: 100%; height: 100%; background: rgba(0,0,0,0.7); animation: fadeIn 0.3s;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.modal-content {
  background: white; margin: 5% auto; padding: 30px; border-radius: 16px;
  max-width: 700px; max-height: 80vh; overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4); animation: slideDown 0.3s ease;
}
@keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.modal-close {
  float: right; font-size: 32px; font-weight: bold; color: #aaa;
  cursor: pointer; line-height: 20px; transition: color 0.2s;
}
.modal-close:hover { color: #333; }

.trade-section { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
.trade-section h4 { margin-top: 0; color: #2c3e50; }

.property-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 10px; margin: 10px 0;
}

.property-item {
  padding: 10px; border: 2px solid #ddd; border-radius: 6px;
  cursor: pointer; transition: all 0.2s; background: white;
}
.property-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
.property-item.selected { border-color: #667eea; background: #e8eaf6; }

.money-input {
  width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ddd;
  border-radius: 6px; margin: 5px 0;
}

.trade-buttons { display: flex; gap: 10px; margin-top: 20px; }
.trade-buttons button {
  flex: 1; padding: 15px; font-size: 16px; font-weight: bold;
  border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;
}

.trade-btn-send { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
.trade-btn-cancel { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }

#auction-modal {
  display: none; position: fixed; z-index: 2000; left: 0; top: 0;
  width: 100%; height: 100%; background: rgba(0,0,0,0.85); animation: fadeIn 0.3s;
}

#auction-content {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  margin: 3% auto; padding: 0; border-radius: 20px; max-width: 600px;
  box-shadow: 0 10px 50px rgba(0,0,0,0.5); overflow: hidden; animation: slideDown 0.3s ease;
}

.auction-header {
  background: rgba(255,255,255,0.15); padding: 25px; text-align: center;
  color: white; backdrop-filter: blur(10px);
}
.auction-header h2 { margin: 0 0 10px 0; font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
.auction-tile-name { font-size: 20px; font-weight: bold; margin: 5px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
.auction-price { font-size: 16px; opacity: 0.9; }
.auction-current-bid {
  font-size: 32px; font-weight: bold; margin: 15px 0; padding: 15px;
  background: rgba(255,255,255,0.2); border-radius: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.auction-body { background: white; padding: 25px; }
.auction-timer { width: 100%; height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden; margin-bottom: 20px; }
#auction-timer-bar { height: 100%; background: linear-gradient(90deg, #27ae60, #f39c12); transition: width 1s linear; }

.auction-players-grid { display: flex; flex-direction: column; gap: 10px; margin: 20px 0; }
.auction-player-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 15px; background: #f8f9fa; border-radius: 8px;
  border: 2px solid transparent; transition: all 0.3s;
}
.auction-player-row.current-bidder { border-color: #e74c3c; background: #fff5f5; box-shadow: 0 0 15px rgba(231, 76, 60, 0.3); }
.auction-player-row.passed { opacity: 0.5; background: #ecf0f1; }
.auction-player-row.ai-row { background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); }

.auction-player-name { font-weight: bold; font-size: 16px; }
.auction-player-cash { font-size: 14px; color: #7f8c8d; margin-top: 3px; }
.auction-player-status { font-size: 14px; font-weight: bold; padding: 5px 10px; border-radius: 5px; background: #e8f5e9; color: #27ae60; }
.auction-player-status.out { background: #ffebee; color: #c62828; }

.auction-bid-btn {
  padding: 10px 20px; font-size: 14px; font-weight: bold; border: none;
  border-radius: 6px; cursor: pointer; transition: all 0.2s;
}
.auction-bid-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.btn-bid { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
.btn-bid:not(:disabled):hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(67, 233, 123, 0.4); }

.btn-pass { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
.btn-pass:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(240, 147, 251, 0.4); }

.auction-log {
  margin-top: 20px; padding: 15px; background: #ecf0f1; border-radius: 8px;
  max-height: 150px; overflow-y: auto; font-size: 13px; color: #2c3e50;
}
.auction-log-title { font-weight: bold; margin-bottom: 10px; color: #34495e; }

.trade-offer-modal {
  display: none; position: fixed; z-index: 3000; left: 0; top: 0;
  width: 100%; height: 100%; background: rgba(0,0,0,0.7);
}

.trade-offer-content {
  background: white; margin: 10% auto; padding: 30px; border-radius: 16px;
  max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); animation: slideDown 0.3s ease;
}

.trade-offer-section { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }

.trade-offer-buttons { display: flex; gap: 10px; margin-top: 20px; }
.trade-offer-buttons button {
  flex: 1; padding: 15px; font-size: 16px; font-weight: bold;
  border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;
}

.accept-btn { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
.reject-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
</style>
</head>
<body>

<div id="menu-screen">
  <h3>üé≤ Monopoly Classic</h3>
  <button class="menu-button ai" onclick="selectGameMode('ai')">
    ü§ñ Play vs AI
    <div class="subtitle">Challenge computer opponents</div>
  </button>
  <button class="menu-button online" onclick="selectGameMode('online')">
    üåê Play Online
    <div class="subtitle">Connect with friends remotely</div>
  </button>
  <button class="menu-button local" onclick="selectGameMode('local')">
    üë• Local Multiplayer
    <div class="subtitle">Pass and play on one device</div>
  </button>
</div>

<div id="player-count-screen">
  <h3>How many players?</h3>
  <div>
    <button class="player-count-btn" onclick="startGame(2)">2</button>
    <button class="player-count-btn" onclick="startGame(3)">3</button>
    <button class="player-count-btn" onclick="startGame(4)">4</button>
  </div>
  <button class="menu-button" onclick="backToMenu()" style="margin-top: 30px;">‚Üê Back</button>
</div>

<div id="online-lobby">
  <h3>üåê Online Lobby</h3>
  <div class="lobby-section">
    <h4>Host a Game</h4>
    <button class="menu-button" onclick="createRoom()">Create Room</button>
    <div id="room-code-section" style="display:none; margin-top:15px;">
      <p><strong>Your Room Code:</strong></p>
      <div class="room-code-display" id="room-code">----</div>
      <p style="color:#7f8c8d; font-size:14px;">Share this code with your friend!</p>
    </div>
  </div>
  <div class="lobby-section">
    <h4>Join a Game</h4>
    <input type="text" class="lobby-input" id="join-code-input" placeholder="Enter Room Code" maxlength="4">
    <button class="menu-button" onclick="joinRoom()">Join Room</button>
  </div>
  <div id="connection-status" class="connection-status" style="display:none;">Connecting...</div>
  <button class="menu-button" onclick="backToMenu()" style="margin-top:20px;">‚Üê Back to Menu</button>
</div>

<div id="game-screen">
  <h2>Monopoly Classic</h2>
  <div id="status"></div>
  <div id="wrap">
    <div id="left-panel">
      <div id="panel"></div>
      <div class="controls">
        <button id="rollBtn" onclick="roll()">üé≤ Roll Dice (Space)</button>
        <button id="buyBtn" onclick="buy()" disabled>üí∞ Buy Property (B)</button>
        <button id="endBtn" onclick="end()" disabled>‚úÖ End Turn (Enter)</button>
        <button id="sellBtn" onclick="toggleSellMode()">üè∑Ô∏è Sell Mode (S)</button>
        <button id="buildBtn" onclick="enterBuildMode('house')">üè† Build (H/V)</button>
        <button id="bailBtn" onclick="payBail()" style="display:none;">üí∏ Pay Bail $50 (B)</button>
        <button id="tradeBtn" onclick="openTradeMenu()">ü§ù Trade (T)</button>
      </div>
    </div>
    <div id="board"></div>
    <div id="log"></div>
  </div>
</div>

<div id="trade-modal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeTradeMenu()">&times;</span>
    <h2>ü§ù Propose Trade</h2>
    <div class="trade-section">
      <h4>Select Trading Partner</h4>
      <div id="trade-partner-list"></div>
    </div>
    <div class="trade-section">
      <h4>You Give</h4>
      <label>Money: $<input type="number" id="trade-give-money" class="money-input" value="0" min="0"></label>
      <div id="trade-give-properties" class="property-grid"></div>
    </div>
    <div class="trade-section">
      <h4>You Receive</h4>
      <label>Money: $<input type="number" id="trade-receive-money" class="money-input" value="0" min="0"></label>
      <div id="trade-receive-properties" class="property-grid"></div>
    </div>
    <div class="trade-buttons">
      <button class="trade-btn-send" onclick="sendTrade()">üì§ Send Offer</button>
      <button class="trade-btn-cancel" onclick="closeTradeMenu()">‚ùå Cancel</button>
    </div>
  </div>
</div>

<div id="trade-offer-modal" class="trade-offer-modal">
  <div class="trade-offer-content">
    <h2>ü§ù Trade Offer Received</h2>
    <p id="trade-offer-from"></p>
    <div class="trade-offer-section">
      <h4>They Give You:</h4>
      <div id="trade-offer-they-give"></div>
    </div>
    <div class="trade-offer-section">
      <h4>You Give Them:</h4>
      <div id="trade-offer-you-give"></div>
    </div>
    <div class="trade-offer-buttons">
      <button class="accept-btn" onclick="acceptTrade()">‚úÖ Accept</button>
      <button class="reject-btn" onclick="rejectTrade()">‚ùå Reject</button>
    </div>
  </div>
</div>

<div id="auction-modal">
  <div id="auction-content">
    <div class="auction-header">
      <h2>üî® AUCTION</h2>
      <div class="auction-tile-name" id="auction-tile-name">Property Name</div>
      <div class="auction-price" id="auction-market-price">Market Price: $XXX</div>
      <div class="auction-current-bid" id="auction-current-bid">Current Bid: $X</div>
    </div>
    <div class="auction-body">
      <div class="auction-timer"><div id="auction-timer-bar"></div></div>
      <div id="auction-players-grid" class="auction-players-grid"></div>
      <div class="auction-log">
        <div class="auction-log-title">üìú Auction History</div>
        <div id="auction-log"></div>
      </div>
    </div>
  </div>
</div>

<script>
// Game state
let tiles = [];
let players = [];
let current = 0;
let rolled = false;
let diceRoll = [0, 0];
let sellingMode = false;
let buildMode = null;
let gameMode = null;
let numPlayers = 0;
let logEntries = [];
let peer = null;
let conn = null;
let isHost = false;
let isMyTurn = false;
let myPlayerIndex = 0;
let roomCode = null;
let currentTrade = null;
let selectedPartner = null;
let tradeGiveProperties = [];
let tradeReceiveProperties = [];
let auction = null;

// Classic Monopoly board setup (40 tiles arranged 8x5)
const MONOPOLY_CLASSIC = [
  { name: 'GO', type: 'go' },
  { name: 'Mediterranean Ave', type: 'property', price: 60, rent: [2, 10, 30, 90, 160, 250], buildCost: 50, row: 0 },
  { name: 'Community Chest', type: 'luck' },
  { name: 'Baltic Ave', type: 'property', price: 60, rent: [4, 20, 60, 180, 320, 450], buildCost: 50, row: 0 },
  { name: 'Income Tax', type: 'tax', amount: 200 },
  { name: 'Reading Railroad', type: 'railroad', price: 200 },
  { name: 'Oriental Ave', type: 'property', price: 100, rent: [6, 30, 90, 270, 400, 550], buildCost: 50, row: 1 },
  { name: 'Chance', type: 'luck' },
  { name: 'Vermont Ave', type: 'property', price: 100, rent: [6, 30, 90, 270, 400, 550], buildCost: 50, row: 1 },
  { name: 'Connecticut Ave', type: 'property', price: 120, rent: [8, 40, 100, 300, 450, 600], buildCost: 50, row: 1 },
  { name: 'Jail/Visiting', type: 'jail' },
  { name: 'St. Charles Place', type: 'property', price: 140, rent: [10, 50, 150, 450, 625, 750], buildCost: 100, row: 2 },
  { name: 'Electric Company', type: 'utility', price: 150 },
  { name: 'States Ave', type: 'property', price: 140, rent: [10, 50, 150, 450, 625, 750], buildCost: 100, row: 2 },
  { name: 'Virginia Ave', type: 'property', price: 160, rent: [12, 60, 180, 500, 700, 900], buildCost: 100, row: 2 },
  { name: 'Pennsylvania RR', type: 'railroad', price: 200 },
  { name: 'St. James Place', type: 'property', price: 180, rent: [14, 70, 200, 550, 750, 950], buildCost: 100, row: 3 },
  { name: 'Community Chest', type: 'luck' },
  { name: 'Tennessee Ave', type: 'property', price: 180, rent: [14, 70, 200, 550, 750, 950], buildCost: 100, row: 3 },
  { name: 'New York Ave', type: 'property', price: 200, rent: [16, 80, 220, 600, 800, 1000], buildCost: 100, row: 3 },
  { name: 'Free Parking', type: 'freeparking' },
  { name: 'Kentucky Ave', type: 'property', price: 220, rent: [18, 90, 250, 700, 875, 1050], buildCost: 150, row: 4 },
  { name: 'Chance', type: 'luck' },
  { name: 'Indiana Ave', type: 'property', price: 220, rent: [18, 90, 250, 700, 875, 1050], buildCost: 150, row: 4 },
  { name: 'Illinois Ave', type: 'property', price: 240, rent: [20, 100, 300, 750, 925, 1100], buildCost: 150, row: 4 },
  { name: 'B&O Railroad', type: 'railroad', price: 200 },
  { name: 'Atlantic Ave', type: 'property', price: 260, rent: [22, 110, 330, 800, 975, 1150], buildCost: 150, row: 5 },
  { name: 'Ventnor Ave', type: 'property', price: 260, rent: [22, 110, 330, 800, 975, 1150], buildCost: 150, row: 5 },
  { name: 'Water Works', type: 'utility', price: 150 },
  { name: 'Marvin Gardens', type: 'property', price: 280, rent: [24, 120, 360, 850, 1025, 1200], buildCost: 150, row: 5 },
  { name: 'Go to Jail', type: 'gotojail' },
  { name: 'Pacific Ave', type: 'property', price: 300, rent: [26, 130, 390, 900, 1100, 1275], buildCost: 200, row: 6 },
  { name: 'North Carolina Ave', type: 'property', price: 300, rent: [26, 130, 390, 900, 1100, 1275], buildCost: 200, row: 6 },
  { name: 'Community Chest', type: 'luck' },
  { name: 'Pennsylvania Ave', type: 'property', price: 320, rent: [28, 150, 450, 1000, 1200, 1400], buildCost: 200, row: 6 },
  { name: 'Short Line RR', type: 'railroad', price: 200 },
  { name: 'Chance', type: 'luck' },
  { name: 'Park Place', type: 'property', price: 350, rent: [35, 175, 500, 1100, 1300, 1500], buildCost: 200, row: 7 },
  { name: 'Luxury Tax', type: 'tax', amount: 100 },
  { name: 'Boardwalk', type: 'property', price: 400, rent: [50, 200, 600, 1400, 1700, 2000], buildCost: 200, row: 7 }
];

function resetGame(numP = 2) {
  tiles = MONOPOLY_CLASSIC.map((template, i) => ({ ...template, o: -1, h: 0, v: 0 }));
  const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12'];
  const names = ['Red', 'Blue', 'Green', 'Orange'];
  players = [];
  for (let i = 0; i < numP; i++) {
    players.push({ pos: 0, money: 1500, jailTurns: 0, color: colors[i], name: names[i], isAI: false });
  }
  if (gameMode === 'ai') {
    for (let i = 1; i < numP; i++) {
      players[i].isAI = true;
      players[i].name += ' ü§ñ';
    }
  }
  current = 0;
  rolled = false;
  diceRoll = [0, 0];
  sellingMode = false;
  buildMode = null;
  logEntries = [];
  draw();
  updatePanels();
  updateButtons();
  log('üéÆ Game started! Roll the dice.', 'log-action');
  if (gameMode === 'online') {
    isMyTurn = isHost ? (current === 0) : (current === 1);
  }
}

function selectGameMode(mode) {
  gameMode = mode;
  document.getElementById('menu-screen').style.display = 'none';
  if (mode === 'online') {
    document.getElementById('online-lobby').style.display = 'block';
  } else {
    document.getElementById('player-count-screen').style.display = 'block';
  }
}

function backToMenu() {
  gameMode = null;
  document.getElementById('menu-screen').style.display = 'block';
  document.getElementById('player-count-screen').style.display = 'none';
  document.getElementById('online-lobby').style.display = 'none';
  document.getElementById('game-screen').style.display = 'none';
  if (conn) conn.close();
  if (peer) peer.destroy();
  conn = null;
  peer = null;
}

function startGame(numP) {
  numPlayers = numP;
  document.getElementById('player-count-screen').style.display = 'none';
  document.getElementById('game-screen').style.display = 'block';
  resetGame(numP);
}

function generateRoomCode() {
  return Math.random().toString(36).substr(2, 4).toUpperCase();
}

function createRoom() {
  roomCode = generateRoomCode();
  peer = new Peer(roomCode, {
    config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
  });
  peer.on('open', (id) => {
    isHost = true;
    document.getElementById('room-code').textContent = roomCode;
    document.getElementById('room-code-section').style.display = 'block';
    showConnectionStatus('Waiting for player to join...', 'waiting');
  });
  peer.on('connection', (connection) => {
    conn = connection;
    setupConnection();
    showConnectionStatus('Player connected! Starting game...', 'connected');
    setTimeout(() => {
      document.getElementById('online-lobby').style.display = 'none';
      document.getElementById('game-screen').style.display = 'block';
      myPlayerIndex = 0;
      startGame(2);
      sendAction('sync', { tiles: tiles, players: players, current: current });
    }, 1000);
  });
  peer.on('error', (err) => {
    showConnectionStatus('Connection error: ' + err.message, 'error');
  });
}

function joinRoom() {
  const code = document.getElementById('join-code-input').value.toUpperCase().trim();
  if (code.length !== 4) {
    showConnectionStatus('Please enter a 4-character room code', 'error');
    return;
  }
  peer = new Peer({ config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] } });
  peer.on('open', () => {
    conn = peer.connect(code);
    isHost = false;
    myPlayerIndex = 1;
    setupConnection();
    showConnectionStatus('Connecting to host...', 'waiting');
  });
  peer.on('error', (err) => {
    showConnectionStatus('Failed to join room: ' + err.message, 'error');
  });
}

function setupConnection() {
  conn.on('open', () => {
    if (!isHost) {
      showConnectionStatus('Connected! Waiting for game to start...', 'connected');
    }
  });
  conn.on('data', (data) => {
    handleRemoteAction(data);
  });
  conn.on('close', () => {
    showConnectionStatus('Connection lost', 'error');
    alert('Connection to other player lost. Returning to menu.');
    backToMenu();
  });
}

function showConnectionStatus(message, type) {
  const statusDiv = document.getElementById('connection-status');
  statusDiv.textContent = message;
  statusDiv.style.display = 'block';
  statusDiv.className = 'connection-status status-' + type;
}

function sendAction(action, data = {}) {
  if (!conn || gameMode !== 'online') return;
  conn.send({ action: action, data: data });
}

function handleRemoteAction(message) {
  const { action, data } = message;
  switch (action) {
    case 'sync':
      tiles = data.tiles;
      players = data.players;
      current = data.current;
      document.getElementById('online-lobby').style.display = 'none';
      document.getElementById('game-screen').style.display = 'block';
      draw();
      updatePanels();
      updateButtons();
      break;
    case 'roll':
      diceRoll = data.dice;
      rolled = true;
      movePlayer(data.newPos);
      landOnTile();
      draw();
      updatePanels();
      updateButtons();
      break;
    case 'buy':
      buyProperty();
      break;
    case 'end':
      switchTurn();
      break;
    case 'sell':
      tiles[data.tileIndex].o = -1;
      players[data.playerIndex].money += data.amount;
      draw();
      updatePanels();
      break;
    case 'build':
      if (data.buildType === 'house') {
        tiles[data.tileIndex].h++;
      } else {
        tiles[data.tileIndex].v++;
      }
      players[data.playerIndex].money -= data.cost;
      draw();
      updatePanels();
      break;
  }
}

function draw() {
  let board = document.getElementById('board');
  board.style.gridTemplateColumns = 'repeat(5, 100px)';
  board.style.gridTemplateRows = 'repeat(8, 100px)';
  board.style.width = '540px';
  board.style.height = '860px';
  board.innerHTML = '';
  for (let i = 0; i < tiles.length; i++) {
    let t = tiles[i];
    let div = document.createElement('div');
    div.className = 'tile';
    div.dataset.index = i;
    if (t.type === 'go') div.classList.add('go-tile');
    else if (t.type === 'jail') div.classList.add('jail-tile');
    else if (t.type === 'gotojail') div.classList.add('gotojail-tile');
    else if (t.type === 'freeparking') div.classList.add('freeparking-tile');
    else if (t.type === 'luck') div.classList.add('luck-tile');
    else if (t.type === 'tax') div.classList.add('tax-tile');
    else if (t.type === 'railroad') div.classList.add('rail-tile');
    else if (t.type === 'utility') div.classList.add('utility-tile');
    if (t.type === 'property' && t.row !== undefined) {
      let hdr = document.createElement('div');
      hdr.className = 'tile-header row-' + t.row;
      hdr.textContent = t.name;
      div.appendChild(hdr);
    } else {
      let hdr = document.createElement('div');
      hdr.className = 'tile-header';
      hdr.textContent = t.name;
      div.appendChild(hdr);
    }
    if (t.type === 'property' || t.type === 'railroad' || t.type === 'utility') {
      let infoDiv = document.createElement('div');
      infoDiv.style.fontSize = '8px';
      infoDiv.style.marginTop = '2px';
      infoDiv.style.lineHeight = '1.3';
      
      // Price
      let priceText = document.createElement('div');
      priceText.style.fontWeight = 'bold';
      priceText.textContent = 'üíµ $' + t.price;
      infoDiv.appendChild(priceText);
      
      // House cost and rents (only for properties)
      if (t.type === 'property') {
        let houseText = document.createElement('div');
        houseText.textContent = 'üè† $' + t.houseCost;
        infoDiv.appendChild(houseText);
        
        let rentText = document.createElement('div');
        rentText.textContent = 'üìä $' + t.baseRent;
        infoDiv.appendChild(rentText);
        
        // Show scaled rent if property has buildings
        if (t.h > 0 || t.v > 0) {
          let currentRent = t.v > 0 ? t.baseRent * 16 : t.baseRent * Math.pow(2, t.h);
          let scaledText = document.createElement('div');
          scaledText.style.color = '#d32f2f';
          scaledText.style.fontWeight = 'bold';
          scaledText.textContent = 'üí∞ $' + currentRent;
          infoDiv.appendChild(scaledText);
        }
      }
      
      div.appendChild(infoDiv);
    }
    if (t.o >= 0) {
      let ownerDiv = document.createElement('div');
      ownerDiv.style.fontSize = '8px';
      ownerDiv.style.color = players[t.o].color;
      ownerDiv.style.fontWeight = 'bold';
      ownerDiv.textContent = 'üë§ ' + players[t.o].name;
      div.appendChild(ownerDiv);
    }
    if (t.h > 0 || t.v > 0) {
      let buildDiv = document.createElement('div');
      buildDiv.style.marginTop = '3px';
      for (let j = 0; j < t.h; j++) {
        let house = document.createElement('div');
        house.className = 'house';
        house.title = 'House';
        buildDiv.appendChild(house);
      }
      for (let j = 0; j < t.v; j++) {
        let villa = document.createElement('div');
        villa.className = 'villa';
        villa.title = 'Hotel';
        buildDiv.appendChild(villa);
      }
      div.appendChild(buildDiv);
    }
    let pawnsHere = players.filter((p, idx) => p.pos === i);
    if (pawnsHere.length > 0) {
      let pawnDiv = document.createElement('div');
      pawnDiv.style.marginTop = '5px';
      pawnsHere.forEach(p => {
        let pawn = document.createElement('div');
        pawn.className = 'pawn';
        pawn.style.background = p.color;
        pawn.title = p.name;
        pawnDiv.appendChild(pawn);
      });
      div.appendChild(pawnDiv);
    }
    if (sellingMode && t.o === current) {
      div.classList.add('sellable');
      div.onclick = () => sellProperty(i);
    }
    if (buildMode && canBuildOn(i)) {
      div.classList.add('buildable');
      div.onclick = () => buildOnProperty(i);
    }
    board.appendChild(div);
  }
}

function roll() {
  if (rolled) {
    log('‚ö†Ô∏è Already rolled this turn!', 'log-action');
    return;
  }
  if (gameMode === 'online' && !isMyTurn) {
    log('‚ö†Ô∏è Wait for your turn!', 'log-action');
    return;
  }
  let p = players[current];
  if (p.jailTurns > 0) {
    diceRoll = [Math.ceil(Math.random() * 6), Math.ceil(Math.random() * 6)];
    rolled = true;
    if (diceRoll[0] === diceRoll[1]) {
      p.jailTurns = 0;
      log(`üé≤ ${p.name} rolled doubles [${diceRoll[0]}, ${diceRoll[1]}] and escaped jail!`, 'log-action');
      movePlayer(p.pos + diceRoll[0] + diceRoll[1]);
      landOnTile();
    } else {
      p.jailTurns--;
      log(`üé≤ ${p.name} rolled [${diceRoll[0]}, ${diceRoll[1]}] ‚Äî ${p.jailTurns} turns left in jail`, 'log-action');
    }
    draw();
    updatePanels();
    updateButtons();
    return;
  }
  diceRoll = [Math.ceil(Math.random() * 6), Math.ceil(Math.random() * 6)];
  rolled = true;
  let total = diceRoll[0] + diceRoll[1];
  log(`üé≤ ${p.name} rolled [${diceRoll[0]}, ${diceRoll[1]}] = ${total}`, 'log-action');
  beep(400);
  let newPos = (p.pos + total) % tiles.length;
  if (gameMode === 'online' && isMyTurn) {
    sendAction('roll', { dice: diceRoll, newPos: newPos });
  }
  movePlayer(newPos);
  landOnTile();
  draw();
  updatePanels();
  updateButtons();
  if (p.isAI) {
    setTimeout(() => aiTakeTurn(), 1500);
  }
}

function movePlayer(newPos) {
  let p = players[current];
  if (newPos < p.pos) {
    p.money += 200;
    log(`üí∞ ${p.name} passed GO ‚Äî Collect $200!`, 'log-income');
    beep(600);
  }
  p.pos = newPos;
}

function landOnTile() {
  let p = players[current];
  let t = tiles[p.pos];
  switch (t.type) {
    case 'go':
      p.money += 200;
      log(`üèÅ ${p.name} landed on GO ‚Äî Collect extra $200!`, 'log-income');
      beep(700);
      break;
    case 'property':
    case 'railroad':
    case 'utility':
      if (t.o === -1) {
        log(`üè† ${t.name} is available for $${t.price}`, 'log-action');
      } else if (t.o === current) {
        log(`üòä ${p.name} landed on own property`, 'log-action');
      } else {
        let rent = calcRent(p.pos);
        p.money -= rent;
        players[t.o].money += rent;
        log(`üí∏ ${p.name} paid $${rent} rent to ${players[t.o].name}`, 'log-expense');
        beep(300);
        checkBankruptcy();
      }
      break;
    case 'luck':
      handleLuck();
      break;
    case 'tax':
      p.money -= t.amount;
      log(`üí∏ ${p.name} paid $${t.amount} in taxes`, 'log-expense');
      beep(300);
      checkBankruptcy();
      break;
    case 'gotojail':
      p.pos = 10;
      p.jailTurns = 3;
      log(`üöì ${p.name} sent to JAIL!`, 'log-expense');
      beep(200);
      break;
    case 'freeparking':
      log(`üÖøÔ∏è ${p.name} resting at Free Parking`, 'log-action');
      break;
    case 'jail':
      log(`üëÄ ${p.name} is just visiting Jail`, 'log-action');
      break;
  }
}

function calcRent(tileIndex) {
  let t = tiles[tileIndex];
  if (t.type === 'utility') {
    let owned = tiles.filter(tile => tile.type === 'utility' && tile.o === t.o).length;
    let multiplier = owned === 2 ? 10 : 4;
    return (diceRoll[0] + diceRoll[1]) * multiplier;
  }
  if (t.type === 'railroad') {
    let owned = tiles.filter(tile => tile.type === 'railroad' && tile.o === t.o).length;
    return [25, 50, 100, 200][owned - 1];
  }
  if (t.v > 0) return t.rent[5];
  if (t.h > 0) return t.rent[t.h];
  let sameRow = tiles.filter(tile => tile.type === 'property' && tile.row === t.row);
  let monopoly = sameRow.every(tile => tile.o === t.o);
  return monopoly ? t.rent[0] * 2 : t.rent[0];
}

function handleLuck() {
  let events = [
    { msg: 'üéâ Bank error in your favor ‚Äî Collect $200!', money: 200 },
    { msg: 'üè• Doctor fees ‚Äî Pay $50', money: -50 },
    { msg: 'üí∞ You won a lottery ‚Äî Collect $100!', money: 100 },
    { msg: 'üéÇ Birthday! Each player gives you $10', special: 'birthday' },
    { msg: 'üöó Speeding fine ‚Äî Pay $15', money: -15 },
    { msg: 'üìö School fees ‚Äî Pay $150', money: -150 },
    { msg: 'üèÜ Win a competition ‚Äî Collect $25!', money: 25 }
  ];
  let event = events[Math.floor(Math.random() * events.length)];
  let p = players[current];
  if (event.special === 'birthday') {
    players.forEach((other, idx) => {
      if (idx !== current) {
        other.money -= 10;
        p.money += 10;
      }
    });
  } else {
    p.money += event.money;
  }
  log(event.msg, event.money >= 0 ? 'log-income' : 'log-expense');
  beep(event.money >= 0 ? 600 : 300);
  checkBankruptcy();
}

function buy() {
  let p = players[current];
  let t = tiles[p.pos];
  if (t.type !== 'property' && t.type !== 'railroad' && t.type !== 'utility') {
    log('‚ö†Ô∏è Cannot buy this tile', 'log-action');
    return;
  }
  if (t.o !== -1) {
    log('‚ö†Ô∏è Property already owned', 'log-action');
    return;
  }
  if (p.money < t.price) {
    log('‚ö†Ô∏è Not enough money!', 'log-expense');
    return;
  }
 
  buyProperty();
}

function buyProperty() {
  let p = players[current];
  let t = tiles[p.pos];
  p.money -= t.price;
  t.o = current;
  log(`üè† ${p.name} bought ${t.name} for $${t.price}`, 'log-income');
  beep(600);
  if (gameMode === 'online' && isMyTurn) {
    sendAction('buy');
  }
  draw();
  updatePanels();
  updateButtons();
  checkBankruptcy();
}

function end() {
  if (!rolled && players[current].jailTurns === 0) {
    log('‚ö†Ô∏è Must roll first!', 'log-action');
    return;
  }
  let p = players[current];
  let t = tiles[p.pos];
  if (rolled && !p.isAI && (t.type === 'property' || t.type === 'railroad' || t.type === 'utility') && t.o === -1) {
    log(`üî® ${t.name} not purchased ‚Äî Starting auction!`, 'log-action');
    startAuction(p.pos);
    return;
  }
  let inJail = p.jailTurns > 0;
  if (sellingMode) toggleSellMode();
  if (buildMode) exitBuildMode();
  if (!inJail) {
    log(`‚úÖ ${p.name} ended turn`, 'log-action');
  }
  rolled = false;
  if (gameMode === 'online' && isMyTurn) {
    sendAction('end');
  }
  switchTurn();
}

function switchTurn() {
  current = (current + 1) % players.length;
  if (gameMode === 'online') {
    isMyTurn = (current === myPlayerIndex);
  }
  draw();
  updatePanels();
  updateButtons();
  if (players[current].isAI) {
    setTimeout(() => {
      roll();
    }, 1000);
  }
}

function payBail() {
  let p = players[current];
  if (p.jailTurns === 0) {
    log('‚ö†Ô∏è Not in jail!', 'log-action');
    return;
  }
  if (p.money < 50) {
    log('‚ö†Ô∏è Not enough money for bail!', 'log-expense');
    return;
  }
  p.money -= 50;
  p.jailTurns = 0;
  log(`üîì ${p.name} paid $50 bail and left jail`, 'log-expense');
  beep(500);
  draw();
  updatePanels();
  updateButtons();
}

function toggleSellMode() {
  sellingMode = !sellingMode;
  if (buildMode) buildMode = null;
  if (sellingMode) {
    log('üè∑Ô∏è Sell Mode: Click a property you own to sell it', 'log-action');
  } else {
    log('‚ùå Sell Mode cancelled', 'log-action');
  }
  draw();
  updateButtons();
}

function sellProperty(tileIndex) {
  let t = tiles[tileIndex];
  let p = players[current];
  if (t.o !== current) {
    log('‚ö†Ô∏è You don\'t own this property', 'log-action');
    return;
  }
  if (t.h > 0 || t.v > 0) {
    log('‚ö†Ô∏è Must sell buildings first!', 'log-action');
    return;
  }
  let sellPrice = Math.floor(t.price * 0.5);
  if (!confirm(`Sell ${t.name} for $${sellPrice}?`)) return;
  t.o = -1;
  p.money += sellPrice;
  log(`üíµ ${p.name} sold ${t.name} for $${sellPrice}`, 'log-income');
  beep(500);
  if (gameMode === 'online' && isMyTurn) {
    sendAction('sell', { tileIndex: tileIndex, playerIndex: current, amount: sellPrice });
  }
  sellingMode = false;
  draw();
  updatePanels();
  updateButtons();
}

function enterBuildMode(type) {
  if (sellingMode) sellingMode = false;
  buildMode = type;
  log(`üèóÔ∏è Build Mode (${type === 'house' ? 'House' : 'Hotel'}): Click a property to build`, 'log-action');
  draw();
  updateButtons();
}

function exitBuildMode() {
  buildMode = null;
  log('‚ùå Build Mode cancelled', 'log-action');
  draw();
  updateButtons();
}

function canBuildOn(tileIndex) {
  let t = tiles[tileIndex];
  if (t.type !== 'property') return false;
  if (t.o !== current) return false;
  let sameRow = tiles.filter(tile => tile.type === 'property' && tile.row === t.row);
  let monopoly = sameRow.every(tile => tile.o === current);
  if (!monopoly) return false;
  if (buildMode === 'house') {
    if (t.h >= 4) return false;
    if (t.v > 0) return false;
    return players[current].money >= t.buildCost;
  }
  if (buildMode === 'villa') {
    if (t.h < 4) return false;
    if (t.v > 0) return false;
    return players[current].money >= t.buildCost;
  }
  return false;
}

function buildOnProperty(tileIndex) {
  let t = tiles[tileIndex];
  let p = players[current];
  if (!canBuildOn(tileIndex)) return;
  if (buildMode === 'house') {
    t.h++;
    p.money -= t.buildCost;
    log(`üè† ${p.name} built a house on ${t.name} for $${t.buildCost}`, 'log-expense');
  } else if (buildMode === 'villa') {
    t.h = 0;
    t.v++;
    p.money -= t.buildCost;
    log(`üè® ${p.name} built a hotel on ${t.name} for $${t.buildCost}`, 'log-expense');
  }
  beep(700);
  if (gameMode === 'online' && isMyTurn) {
    sendAction('build', { tileIndex: tileIndex, playerIndex: current, buildType: buildMode, cost: t.buildCost });
  }
  buildMode = null;
  draw();
  updatePanels();
  updateButtons();
  checkBankruptcy();
}

function aiTakeTurn() {
  let p = players[current];
  let t = tiles[p.pos];
  if ((t.type === 'property' || t.type === 'railroad' || t.type === 'utility') && t.o === -1) {
    if (p.money >= t.price * 1.2) {
      setTimeout(() => {
        buyProperty();
        setTimeout(() => aiEndTurn(), 800);
      }, 800);
      return;
    } else {
      setTimeout(() => {
        startAuction(p.pos);
      }, 800);
      return;
    }
  }
  setTimeout(() => aiEndTurn(), 1200);
}

function aiEndTurn() {
  end();
}

function openTradeMenu() {
  if (players[current].isAI) {
    log('‚ö†Ô∏è AI players cannot initiate trades', 'log-action');
    return;
  }
  document.getElementById('trade-modal').style.display = 'block';
  renderTradePartners();
}

function closeTradeMenu() {
  document.getElementById('trade-modal').style.display = 'none';
  selectedPartner = null;
  tradeGiveProperties = [];
  tradeReceiveProperties = [];
}

function renderTradePartners() {
  let list = document.getElementById('trade-partner-list');
  list.innerHTML = '';
  players.forEach((p, idx) => {
    if (idx === current) return;
    let btn = document.createElement('button');
    btn.textContent = p.name;
    btn.style.cssText = `padding:10px 20px;margin:5px;background:${p.color};color:white;border:none;border-radius:6px;cursor:pointer;font-weight:bold;`;
    if (selectedPartner === idx) {
      btn.style.border = '3px solid black';
    }
    btn.onclick = () => selectTradePartner(idx);
    list.appendChild(btn);
  });
}

function selectTradePartner(idx) {
  selectedPartner = idx;
  renderTradePartners();
  renderTradeProperties();
}

function renderTradeProperties() {
  if (selectedPartner === null) return;
  let giveDiv = document.getElementById('trade-give-properties');
  giveDiv.innerHTML = '';
  tiles.forEach((t, i) => {
    if (t.o === current && (t.type === 'property' || t.type === 'railroad' || t.type === 'utility')) {
      let item = document.createElement('div');
      item.className = 'property-item';
      if (tradeGiveProperties.includes(i)) item.classList.add('selected');
      item.textContent = t.name;
      item.onclick = () => toggleGiveProperty(i);
      giveDiv.appendChild(item);
    }
  });
  let receiveDiv = document.getElementById('trade-receive-properties');
  receiveDiv.innerHTML = '';
  tiles.forEach((t, i) => {
    if (t.o === selectedPartner && (t.type === 'property' || t.type === 'railroad' || t.type === 'utility')) {
      let item = document.createElement('div');
      item.className = 'property-item';
      if (tradeReceiveProperties.includes(i)) item.classList.add('selected');
      item.textContent = t.name;
      item.onclick = () => toggleReceiveProperty(i);
      receiveDiv.appendChild(item);
    }
  });
}

function toggleGiveProperty(idx) {
  let i = tradeGiveProperties.indexOf(idx);
  if (i > -1) {
    tradeGiveProperties.splice(i, 1);
  } else {
    tradeGiveProperties.push(idx);
  }
  renderTradeProperties();
}

function toggleReceiveProperty(idx) {
  let i = tradeReceiveProperties.indexOf(idx);
  if (i > -1) {
    tradeReceiveProperties.splice(i, 1);
  } else {
    tradeReceiveProperties.push(idx);
  }
  renderTradeProperties();
}

function sendTrade() {
  if (selectedPartner === null) {
    alert('Select a trading partner first!');
    return;
  }
  let giveMoney = parseInt(document.getElementById('trade-give-money').value) || 0;
  let receiveMoney = parseInt(document.getElementById('trade-receive-money').value) || 0;
  if (tradeGiveProperties.length === 0 && tradeReceiveProperties.length === 0 && giveMoney === 0 && receiveMoney === 0) {
    alert('Add something to the trade!');
    return;
  }
  currentTrade = {
    from: current,
    to: selectedPartner,
    giveProperties: [...tradeGiveProperties],
    receiveProperties: [...tradeReceiveProperties],
    giveMoney: giveMoney,
    receiveMoney: receiveMoney
  };
  closeTradeMenu();
  if (players[selectedPartner].isAI) {
    setTimeout(() => evaluateAITrade(), 1000);
  } else {
    showTradeOffer();
  }
}

function showTradeOffer() {
  let trade = currentTrade;
  document.getElementById('trade-offer-from').textContent = `Trade offer from ${players[trade.from].name}:`;
  let theyGive = document.getElementById('trade-offer-they-give');
  theyGive.innerHTML = '';
  if (trade.giveMoney > 0) {
    let money = document.createElement('div');
    money.textContent = `üíµ $${trade.giveMoney}`;
    theyGive.appendChild(money);
  }
  trade.giveProperties.forEach(i => {
    let prop = document.createElement('div');
    prop.textContent = `üè† ${tiles[i].name}`;
    theyGive.appendChild(prop);
  });
  if (trade.giveMoney === 0 && trade.giveProperties.length === 0) {
    theyGive.textContent = 'Nothing';
  }
  let youGive = document.getElementById('trade-offer-you-give');
  youGive.innerHTML = '';
  if (trade.receiveMoney > 0) {
    let money = document.createElement('div');
    money.textContent = `üíµ $${trade.receiveMoney}`;
    youGive.appendChild(money);
  }
  trade.receiveProperties.forEach(i => {
    let prop = document.createElement('div');
    prop.textContent = `üè† ${tiles[i].name}`;
    youGive.appendChild(prop);
  });
  if (trade.receiveMoney === 0 && trade.receiveProperties.length === 0) {
    youGive.textContent = 'Nothing';
  }
  document.getElementById('trade-offer-modal').style.display = 'block';
}

function acceptTrade() {
  let trade = currentTrade;
  players[trade.from].money -= trade.giveMoney;
  players[trade.to].money += trade.giveMoney;
  players[trade.to].money -= trade.receiveMoney;
  players[trade.from].money += trade.receiveMoney;
  trade.giveProperties.forEach(i => {
    tiles[i].o = trade.to;
  });
  trade.receiveProperties.forEach(i => {
    tiles[i].o = trade.from;
  });
  log(`ü§ù Trade accepted between ${players[trade.from].name} and ${players[trade.to].name}!`, 'log-income');
  beep(700);
  document.getElementById('trade-offer-modal').style.display = 'none';
  currentTrade = null;
  draw();
  updatePanels();
}

function rejectTrade() {
  log(`‚ùå Trade rejected by ${players[currentTrade.to].name}`, 'log-action');
  document.getElementById('trade-offer-modal').style.display = 'none';
  currentTrade = null;
}

function evaluateAITrade() {
  let trade = currentTrade;
  let giveValue = trade.giveMoney;
  trade.giveProperties.forEach(i => {
    giveValue += tiles[i].price;
  });
  let receiveValue = trade.receiveMoney;
  trade.receiveProperties.forEach(i => {
    receiveValue += tiles[i].price;
  });
  if (receiveValue >= giveValue * 0.9) {
    acceptTrade();
  } else {
    rejectTrade();
  }
}

function startAuction(tileIndex) {
  let t = tiles[tileIndex];
  auction = {
    tileIndex: tileIndex,
    tilePrice: t.price,
    currentBid: 0,
    highBidder: null,
    participants: [],
    activeSeat: 0,
    auctionLog: [],
    timerInterval: null
  };
  players.forEach((p, idx) => {
    auction.participants.push({
      playerIndex: idx,
      passed: false,
      isAI: p.isAI
    });
  });
  auction.activeSeat = (current + 1) % players.length;
  document.getElementById('auction-modal').style.display = 'block';
  renderAuction();
  advanceAuctionIfAI();
}

function renderAuction() {
  if (!auction) return;
  let t = tiles[auction.tileIndex];
  document.getElementById('auction-tile-name').textContent = t.name;
  document.getElementById('auction-market-price').textContent = `Market Price: $${auction.tilePrice}`;
  let bidDiv = document.getElementById('auction-current-bid');
  if (auction.currentBid === 0) {
    bidDiv.textContent = 'No bids yet ‚Äî starts at $1';
  } else {
    bidDiv.textContent = `Current Bid: $${auction.currentBid}`;
    if (auction.highBidder !== null) {
      let bidder = auction.participants[auction.highBidder];
      bidDiv.textContent += ` by ${players[bidder.playerIndex].name}`;
    }
  }
  resetAuctionTimer();
  let grid = document.getElementById('auction-players-grid');
  grid.innerHTML = '';
  auction.participants.forEach((part, seat) => {
    let p = players[part.playerIndex];
    let isActive = seat === auction.activeSeat && !part.passed;
    let isBidder = seat === auction.highBidder;
    let isOut = part.passed;
    let row = document.createElement('div');
    row.className = 'auction-player-row' + (isActive ? ' current-bidder' : '') + (isOut ? ' passed' : '') + (part.isAI ? ' ai-row' : '');
    let nextBid = auction.currentBid + 50;
    let canAfford = p.money >= nextBid;
    let statusHtml = '';
    if (isOut) {
      statusHtml = '<span class="auction-player-status out">‚õî Passed</span>';
    } else if (isBidder) {
      statusHtml = '<span class="auction-player-status">üèÜ Winning</span>';
    } else if (isActive) {
      statusHtml = '<span class="auction-player-status" style="color:#e74c3c;">‚è≥ Your turn</span>';
    }
    let buttonsHtml = '';
    if (!isOut && isActive && !part.isAI) {
      buttonsHtml = `<button class="auction-bid-btn btn-bid" onclick="auctionBid()" ${!canAfford ? 'disabled' : ''}>Bid $${nextBid}</button><button class="auction-bid-btn btn-pass" onclick="auctionPass()">Pass</button>`;
    }
    row.innerHTML = `<div><div class="auction-player-name" style="color:${p.color}">${p.name}${part.isAI ? ' ü§ñ' : ''}</div><div class="auction-player-cash">Cash: $${p.money}</div></div>${statusHtml}<div style="display:flex;gap:6px;">${buttonsHtml}</div>`;
    grid.appendChild(row);
  });
  let logDiv = document.getElementById('auction-log');
  logDiv.innerHTML = auction.auctionLog.slice(-8).join('<br>');
  logDiv.scrollTop = logDiv.scrollHeight;
}

function auctionLog(msg) {
  auction.auctionLog.push(msg);
}

function resetAuctionTimer() {
  if (auction.timerInterval) clearInterval(auction.timerInterval);
  let seconds = 20;
  let bar = document.getElementById('auction-timer-bar');
  bar.style.transition = 'none';
  bar.style.width = '100%';
  setTimeout(() => {
    bar.style.transition = 'width 1s linear';
  }, 50);
  auction.timerInterval = setInterval(() => {
    seconds--;
    let pct = (seconds / 20) * 100;
    bar.style.width = pct + '%';
    bar.style.background = seconds > 10 ? 'linear-gradient(90deg, #27ae60, #f39c12)' : 'linear-gradient(90deg, #e74c3c, #c0392b)';
    if (seconds <= 0) {
      clearInterval(auction.timerInterval);
      let part = auction.participants[auction.activeSeat];
      if (!part.passed && !part.isAI) {
        auctionLog(`‚è∞ ${players[part.playerIndex].name} timed out ‚Äî auto-passed`);
        auctionPass();
      }
    }
  }, 1000);
}

function calcNextBid() {
  return auction.currentBid + 50;
}

function auctionBid() {
  if (!auction) return;
  let seat = auction.activeSeat;
  let part = auction.participants[seat];
  let p = players[part.playerIndex];
  let nextBid = calcNextBid();
  if (p.money < nextBid) {
    auctionLog(`‚ùå ${p.name} can't afford $${nextBid}!`);
    renderAuction();
    return;
  }
  auction.currentBid = nextBid;
  auction.highBidder = seat;
  auctionLog(`üí∞ ${p.name} bids $${nextBid}`);
  beep(600);
  advanceAuctionSeat();
}

function auctionPass() {
  if (!auction) return;
  let seat = auction.activeSeat;
  let part = auction.participants[seat];
  auctionLog(`üôÖ ${players[part.playerIndex].name} passes`);
  auction.participants[seat].passed = true;
  beep(300);
  advanceAuctionSeat();
}

function advanceAuctionSeat() {
  if (auction.timerInterval) clearInterval(auction.timerInterval);
  let active = auction.participants.filter(p => !p.passed);
  if (active.length === 1) {
    finishAuction(active[0]);
    return;
  }
  if (active.length === 0) {
    finishAuction(null);
    return;
  }
  let next = (auction.activeSeat + 1) % auction.participants.length;
  let loops = 0;
  while (auction.participants[next].passed) {
    next = (next + 1) % auction.participants.length;
    loops++;
    if (loops > auction.participants.length) {
      finishAuction(null);
      return;
    }
  }
  auction.activeSeat = next;
  renderAuction();
  advanceAuctionIfAI();
}

function advanceAuctionIfAI() {
  if (!auction) return;
  let part = auction.participants[auction.activeSeat];
  if (!part || part.passed || !part.isAI) return;
  setTimeout(() => {
    if (!auction) return;
    let p = players[part.playerIndex];
    let nextBid = calcNextBid();
    let bidThreshold = auction.tilePrice * 0.75;
    let shouldBid = nextBid <= bidThreshold && p.money >= nextBid * 2 && Math.random() > 0.25;
    if (shouldBid) {
      auctionBid();
    } else {
      auctionPass();
    }
  }, 700 + Math.random() * 500);
}

function finishAuction(winner) {
  if (auction.timerInterval) clearInterval(auction.timerInterval);
  if (!winner || auction.highBidder === null) {
    auctionLog('üèöÔ∏è No bids ‚Äî property remains unowned.');
    log(`üèöÔ∏è Auction for Tile ${auction.tileIndex} ended with no winner. Property stays unowned.`, 'log-action');
    beep(200);
    closeAuction();
    return;
  }
  let pIdx = winner.playerIndex;
  let finalPrice = auction.currentBid;
  players[pIdx].money -= finalPrice;
  tiles[auction.tileIndex].o = pIdx;
  auctionLog(`üéâ ${players[pIdx].name} won Tile ${auction.tileIndex} for $${finalPrice}!`);
  log(`üî® ${players[pIdx].name} won auction for Tile ${auction.tileIndex} at $${finalPrice}! (Market: $${auction.tilePrice})`, 'log-income');
  beep(700);
  beep(900);
  renderAuction();
  setTimeout(() => {
    closeAuction();
    checkBankruptcy();
  }, 1200);
}

function closeAuction() {
  if (auction && auction.timerInterval) clearInterval(auction.timerInterval);
  auction = null;
  document.getElementById('auction-modal').style.display = 'none';
  draw();
  updatePanels();
  updateButtons();
  _endTurnAfterAuction();
}

function _endTurnAfterAuction() {
  let inJail = players[current].jailTurns > 0;
  if (sellingMode) toggleSellMode();
  if (buildMode) exitBuildMode();
  if (!inJail) {
    log(`‚úÖ ${players[current].name} ended turn`, 'log-action');
  }
  rolled = false;
  if (gameMode === 'online' && isMyTurn) {
    sendAction('end');
  }
  switchTurn();
}

document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT') return;
  if (!gameMode) return;
  if (gameMode === 'online' && !isMyTurn) return;
  let key = e.key.toLowerCase();
  switch(key) {
    case ' ':
      e.preventDefault();
      let rollBtn = document.getElementById('rollBtn');
      if (rollBtn && !rollBtn.disabled) {
        roll();
      }
      break;
    case 'enter':
      e.preventDefault();
      let endBtn = document.getElementById('endBtn');
      if (endBtn && !endBtn.disabled) {
        end();
      }
      break;
    case 'b':
      e.preventDefault();
      let buyBtn = document.getElementById('buyBtn');
      let bailBtn = document.getElementById('bailBtn');
      if (buyBtn && !buyBtn.disabled) {
        buy();
      } else if (bailBtn && !bailBtn.disabled) {
        payBail();
      }
      break;
    case 's':
      e.preventDefault();
      let sellBtn = document.getElementById('sellBtn');
      if (sellBtn && !sellBtn.disabled) {
        toggleSellMode();
      }
      break;
    case 't':
      e.preventDefault();
      let tradeBtn = document.getElementById('tradeBtn');
      if (tradeBtn && !tradeBtn.disabled) {
        openTradeMenu();
      }
      break;
    case 'h':
      e.preventDefault();
      let houseBtn = document.getElementById('buildBtn');
      if (houseBtn && !houseBtn.disabled) {
        enterBuildMode('house');
      }
      break;
    case 'v':
      e.preventDefault();
      let villaBtn = document.getElementById('buildBtn');
      if (villaBtn && !villaBtn.disabled) {
        enterBuildMode('villa');
      }
      break;
    case 'escape':
      e.preventDefault();
      if (buildMode) {
        exitBuildMode();
      } else if (sellingMode) {
        toggleSellMode();
      }
      break;
  }
});

function updatePanels() {
  let panel = document.getElementById('panel');
  panel.innerHTML = '<h3>Players</h3>';
  players.forEach((p, idx) => {
    let card = document.createElement('div');
    card.className = 'player-card';
    card.style.borderColor = p.color;
    if (idx === current) card.classList.add('active');
    let name = document.createElement('div');
    name.style.fontWeight = 'bold';
    name.style.fontSize = '16px';
    name.textContent = p.name;
    let money = document.createElement('div');
    money.textContent = `üí∞ $${p.money}`;
    let properties = tiles.filter(t => t.o === idx && (t.type === 'property' || t.type === 'railroad' || t.type === 'utility'));
    let propCount = document.createElement('div');
    propCount.style.fontSize = '12px';
    propCount.style.color = '#7f8c8d';
    propCount.textContent = `üè† ${properties.length} properties`;
    card.appendChild(name);
    card.appendChild(money);
    card.appendChild(propCount);
    if (p.jailTurns > 0) {
      let jail = document.createElement('div');
      jail.textContent = `üîí In Jail (${p.jailTurns} turns)`;
      jail.style.color = '#e74c3c';
      jail.style.fontWeight = 'bold';
      card.appendChild(jail);
    }
    panel.appendChild(card);
  });
  let status = document.getElementById('status');
  if (gameMode === 'online') {
    status.textContent = isMyTurn ? `Your turn (${players[current].name})` : `${players[current].name}'s turn`;
  } else {
    status.textContent = `${players[current].name}'s Turn`;
  }
}

function updateButtons() {
  let p = players[current];
  let t = tiles[p.pos];
  let canPlay = (gameMode !== 'online' || isMyTurn);
  document.getElementById('rollBtn').disabled = rolled || !canPlay;
  let canBuy = rolled && (t.type === 'property' || t.type === 'railroad' || t.type === 'utility') && t.o === -1 && p.money >= t.price && canPlay;
  document.getElementById('buyBtn').disabled = !canBuy;
  document.getElementById('endBtn').disabled = !rolled && p.jailTurns === 0 || !canPlay;
  document.getElementById('sellBtn').disabled = !canPlay;
  document.getElementById('buildBtn').disabled = !canPlay;
  document.getElementById('tradeBtn').disabled = !canPlay;
  let bailBtn = document.getElementById('bailBtn');
  if (p.jailTurns > 0 && canPlay) {
    bailBtn.style.display = 'inline-block';
    bailBtn.disabled = p.money < 50;
  } else {
    bailBtn.style.display = 'none';
  }
}

function checkBankruptcy() {
  players.forEach((p, idx) => {
    if (p.money < 0) {
      log(`üíÄ ${p.name} is BANKRUPT!`, 'log-expense');
      beep(200);
      beep(200);
      beep(200);
      tiles.forEach(t => {
        if (t.o === idx) {
          t.o = -1;
          t.h = 0;
          t.v = 0;
        }
      });
      let activePlayers = players.filter(p => p.money >= 0);
      if (activePlayers.length === 1) {
        setTimeout(() => {
          alert(`üèÜ ${activePlayers[0].name} WINS!`);
          backToMenu();
        }, 1000);
      }
    }
  });
}

function log(message, type = '') {
  logEntries.push({ msg: message, type: type });
  let logDiv = document.getElementById('log');
  let entry = document.createElement('div');
  entry.className = 'log-entry ' + type;
  entry.textContent = message;
  logDiv.appendChild(entry);
  logDiv.scrollTop = logDiv.scrollHeight;
}

function beep(freq) {
  if (typeof AudioContext !== 'undefined') {
    try {
      let ctx = new AudioContext();
      let osc = ctx.createOscillator();
      let gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = freq;
      gain.gain.value = 0.1;
      osc.start();
      setTimeout(() => osc.stop(), 100);
    } catch (e) {}
  }
}
</script>
</body>
</html>
